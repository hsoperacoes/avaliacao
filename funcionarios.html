<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lista de Funcionários - Sistema de RH</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    /* Reset e básicas */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;line-height:1.6;color:#333;background:#1a1a1a;min-height:100vh;padding:20px 0}
    .container{max-width:1400px;margin:0 auto;padding:0 20px}

    /* Header */
    .header{background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%);color:#fff;padding:40px 30px;text-align:center;border-radius:15px 15px 0 0;box-shadow:0 4px 20px rgba(0,0,0,.3);position:relative;overflow:hidden}
    .header::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.05) 0%,transparent 70%);animation:rotate 30s linear infinite}
    @keyframes rotate{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    .header-content{position:relative;z-index:1}
    .header-icon{font-size:3em;margin-bottom:20px;color:#FF9800}
    .header h1{font-size:2.2em;font-weight:700;margin-bottom:10px}
    .header h2{font-size:1.4em;font-weight:400;margin-bottom:15px;color:#ecf0f1}
    .header p{font-size:1.1em;opacity:.9;max-width:600px;margin:0 auto}

    /* Container principal */
    .main-container{background:#2a2a2a;border-radius:0 0 15px 15px;box-shadow:0 4px 20px rgba(0,0,0,.3);padding:30px}

    /* Barra de ações */
    .action-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:15px}
    .search-container{display:flex;gap:15px;align-items:center;flex:1;max-width:500px}
    .search-input{flex:1;background:#3a3a3a;border:2px solid #555;border-radius:8px;padding:12px 15px;color:#e0e0e0;font-size:1em}
    .search-input:focus{outline:none;border-color:#FF9800;box-shadow:0 0 0 3px rgba(255,152,0,.2)}
    .filter-select{background:#3a3a3a;border:2px solid #555;border-radius:8px;padding:12px 15px;color:#e0e0e0;font-size:1em;min-width:150px}
    .btn{display:flex;align-items:center;gap:10px;padding:12px 20px;border:none;border-radius:8px;font-size:1em;font-weight:600;cursor:pointer;transition:all .3s ease;text-decoration:none}
    .btn-primary{background:linear-gradient(135deg,#4CAF50 0%,#45a049 100%);color:#fff;box-shadow:0 4px 15px rgba(76,175,80,.3)}
    .btn-secondary{background:linear-gradient(135deg,#FF9800 0%,#F57C00 100%);color:#fff;box-shadow:0 4px 15px rgba(255,152,0,.3)}
    .btn-info{background:linear-gradient(135deg,#2196F3 0%,#1976D2 100%);color:#fff;box-shadow:0 4px 15px rgba(33,150,243,.3)}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.3)}

    /* Lista */
    .employees-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:25px;margin-bottom:30px}
    .employee-card{background:#3a3a3a;border-radius:12px;padding:25px;box-shadow:0 4px 15px rgba(0,0,0,.2);transition:all .3s ease;border-left:4px solid #FF9800;position:relative;overflow:hidden}
    .employee-card:hover{transform:translateY(-5px);box-shadow:0 8px 25px rgba(0,0,0,.3)}
    .employee-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px}
    .employee-info h3{color:#fff;font-size:1.3em;margin-bottom:5px}
    .employee-info .position{color:#FF9800;font-weight:600;margin-bottom:5px}
    .employee-info .start-date{color:#bbb;font-size:.9em}
    .status-badge{padding:4px 10px;border-radius:16px;font-size:.75em;font-weight:800;text-transform:uppercase;background:#666;color:#fff;opacity:.95}
    .status-badge.pending{background:#FFF3E0;color:#F57C00}
    .status-badge.in-progress{background:#E3F2FD;color:#1976D2}
    .status-badge.completed{background:#E8F5E8;color:#388E3C}

    .progress-section{margin-bottom:20px}
    .progress-label{color:#ddd;font-size:.9em;margin-bottom:8px;display:flex;justify-content:space-between}
    .progress-bar-container{background:#4a4a4a;border-radius:10px;height:8px;overflow:hidden}
    .progress-bar{height:100%;border-radius:10px;transition:width .5s ease}
    .progress-bar.pending{background:linear-gradient(90deg,#FF9800,#F57C00)}
    .progress-bar.in-progress{background:linear-gradient(90deg,#2196F3,#1976D2)}
    .progress-bar.completed{background:linear-gradient(90deg,#4CAF50,#45a049)}

    .employee-actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn-small{padding:8px 15px;font-size:.9em;border-radius:6px}

    /* Estado vazio */
    .empty-state{text-align:center;padding:60px 20px;color:#888}
    .empty-state i{font-size:4em;margin-bottom:20px;color:#555}
    .empty-state h3{font-size:1.5em;margin-bottom:10px}
    .empty-state p{font-size:1.1em;margin-bottom:25px}

    /* Responsivo */
    @media(max-width:768px){
      .employees-grid{grid-template-columns:1fr}
      .action-bar{flex-direction:column;align-items:stretch}
      .search-container{max-width:none}
      .employee-actions{justify-content:center}
    }

    /* Animações */
    .fade-in{animation:fadeIn .6s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

    /* Toast */
    .toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%);background:#323232;color:#fff;padding:10px 16px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:9999}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header-content">
        <i class="fas fa-users header-icon"></i>
        <h1>LISTA DE FUNCIONÁRIOS</h1>
        <h2>Gestão de Onboarding</h2>
        <p>Gerencie funcionários aprovados e acompanhe seus processos de integração</p>
      </div>
    </header>

    <div class="main-container">
      <div class="action-bar">
        <div class="search-container">
          <input type="text" class="search-input" id="searchInput" placeholder="Buscar funcionário...">
          <select class="filter-select" id="statusFilter">
            <option value="">Todos os status</option>
            <option value="pending">Pendente</option>
            <option value="in-progress">Em andamento</option>
            <option value="completed">Concluído</option>
          </select>
        </div>
        <div style="display:flex;gap:15px;flex-wrap:wrap;">
          <button class="btn btn-secondary" onclick="openAddEmployeeModal()"><i class="fas fa-user-plus"></i> Adicionar Funcionário</button>
          <button class="btn btn-primary" onclick="reloadFromBackend()"><i class="fas fa-rotate"></i> Sincronizar</button>
          <a href="home.html" class="btn btn-info"><i class="fas fa-home"></i> Home</a>
        </div>
      </div>

      <div class="employees-grid" id="employeesGrid"></div>

      <div class="empty-state" id="emptyState" style="display:none;">
        <i class="fas fa-users-slash"></i>
        <h3>Nenhum funcionário encontrado</h3>
        <p>Adicione funcionários aprovados para começar o processo de onboarding</p>
        <button class="btn btn-secondary" onclick="openAddEmployeeModal()"><i class="fas fa-user-plus"></i> Adicionar Primeiro Funcionário</button>
      </div>
    </div>
  </div>

  <!-- Modal para adicionar funcionário -->
  <div class="modal" id="addEmployeeModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1000;justify-content:center;align-items:center">
    <div class="modal-content" style="background:#2a2a2a;border-radius:15px;padding:30px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto">
      <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #555">
        <h3 style="color:#fff;font-size:1.5em"><i class="fas fa-user-plus"></i> Adicionar Funcionário</h3>
        <button class="close-modal" onclick="closeAddEmployeeModal()" style="background:none;border:none;color:#fff;font-size:1.5em;cursor:pointer;padding:5px"><i class="fas fa-times"></i></button>
      </div>
      <form id="addEmployeeForm">
        <div class="form-group"><label for="employeeName" style="display:block;color:#e0e0e0;font-weight:600;margin-bottom:8px">Nome Completo *</label><input type="text" id="employeeName" required style="width:100%;background:#3a3a3a;border:2px solid #555;border-radius:8px;padding:12px 15px;color:#e0e0e0"></div>
        <div class="form-group"><label for="employeePosition" style="display:block;color:#e0e0e0;font-weight:600;margin-bottom:8px">Cargo *</label><input type="text" id="employeePosition" required style="width:100%;background:#3a3a3a;border:2px solid #555;border-radius:8px;padding:12px 15px;color:#e0e0e0"></div>
        <div class="form-group"><label for="employeeStartDate" style="display:block;color:#e0e0e0;font-weight:600;margin-bottom:8px">Data de Início *</label><input type="date" id="employeeStartDate" required style="width:100%;background:#3a3a3a;border:2px solid #555;border-radius:8px;padding:12px 15px;color:#e0e0e0"></div>
        <div class="form-group"><label for="employeeManager" style="display:block;color:#e0e0e0;font-weight:600;margin-bottom:8px">Gerente Responsável *</label><input type="text" id="employeeManager" required style="width:100%;background:#3a3a3a;border:2px solid #555;border-radius:8px;padding:12px 15px;color:#e0e0e0"></div>
        <div class="form-group"><label for="employeeEmail" style="display:block;color:#e0e0e0;font-weight:600;margin-bottom:8px">E-mail</label><input type="email" id="employeeEmail" style="width:100%;background:#3a3a3a;border:2px solid #555;border-radius:8px;padding:12px 15px;color:#e0e0e0"></div>
        <div style="display:flex;gap:15px;justify-content:flex-end;margin-top:25px;">
          <button type="button" class="btn" style="background:#666" onclick="closeAddEmployeeModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Funcionário</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast">Mensagem</div>

  <script>
    /* === CONFIG: URL do seu GAS publicado como Web App === */
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzx7fZB5WPpdAI7nUADWhzWZF83CyTKIl50jkOeJanoPao9t1eecOQ5CrshZksO5A5e/exec';

    /* Estado em memória */
    let employees = [];

    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('employeeStartDate').value = today;
      // AUTO–SYNC ao abrir
      loadEmployees();
    });

    /* =================== LOAD & SAVE =================== */
    async function fetchEmployeesFromBackend(){
      const url = GAS_WEB_APP_URL + '?type=employees-list';
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error('Falha HTTP na listagem ('+res.status+')');

      let data;
      try { data = await res.json(); }
      catch { throw new Error('Resposta não é JSON (verifique permissões do Web App)'); }

      if(data.ok === false) throw new Error(data.error || 'Backend retornou erro');

      // Aceita "items" OU "employees"
      const arr = Array.isArray(data.items) ? data.items
                : Array.isArray(data.employees) ? data.employees
                : [];
      return arr;
    }

    function derivePct(rec){
      const a = Number(rec.progressPct ?? 0);
      const b = Number(rec.progress ?? 0);
      return Math.max(a, b, 0);
    }

    function computeStatus(p){ if (p>=100) return 'completed'; if (p>0) return 'in-progress'; return 'pending'; }

    function normalizeEmployee(rec){
      const pct = derivePct(rec);
      const status = rec.status || computeStatus(pct);
      const id = rec.employeeId || rec.id || String(Date.now());
      return {
        id,
        employeeId: id,
        name: rec.name || '',
        position: rec.position || '',
        startDate: rec.startDate || '',
        manager: rec.manager || '',
        email: rec.email || '',
        progressPct: pct,
        progress: pct, // compat
        status
      };
    }

    function saveEmployeesLocal(arr){
      localStorage.setItem('employees_sync', JSON.stringify(arr));
      const legacy = arr.map(e => ({ ...e, progress: e.progressPct }));
      localStorage.setItem('employees', JSON.stringify(legacy));
    }

    async function loadEmployees(){
      try{
        const items = await fetchEmployeesFromBackend();
        employees = items.map(normalizeEmployee);
        saveEmployeesLocal(employees);
        renderEmployees();
        console.log('[SYNC] carregados do backend:', employees);
      }catch(err){
        const saved = localStorage.getItem('employees_sync') || localStorage.getItem('employees');
        employees = saved ? JSON.parse(saved) : [];
        renderEmployees();
        toast('Sem conexão com o backend. Carregado do dispositivo.');
        console.warn('[SYNC] erro:', err);
      }
    }

    async function reloadFromBackend(){
      employees = [];
      renderEmployees();
      await loadEmployees();
      toast('Sincronizado com o backend.');
    }

    /* =================== RENDER =================== */
    function renderEmployees(filtered=null){
      const grid = document.getElementById('employeesGrid');
      const emptyState = document.getElementById('emptyState');
      const list = filtered || employees;

      if (!list.length){
        grid.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }
      grid.style.display = 'grid';
      emptyState.style.display = 'none';

      grid.innerHTML = list.map(emp => {
        const pct = typeof emp.progressPct === 'number' ? emp.progressPct : derivePct(emp);
        const stt = emp.status || computeStatus(pct);
        return `
          <div class="employee-card fade-in">
            <div class="employee-header">
              <div class="employee-info">
                <h3>${escapeHtml(emp.name)}</h3>
                <div class="position">${escapeHtml(emp.position || '')}</div>
                <div class="start-date">Início: ${formatDate(emp.startDate)}</div>
              </div>
              <div class="status-badge ${stt}">
                ${getStatusText(stt)}
              </div>
            </div>

            <div class="progress-section">
              <div class="progress-label">
                <span>Progresso do Onboarding</span>
                <span>${pct}%</span>
              </div>
              <div class="progress-bar-container">
                <div class="progress-bar ${stt}" style="width:${pct}%;"></div>
              </div>
            </div>

            <div class="employee-actions">
              <button class="btn btn-info btn-small" onclick="startOnboarding('${emp.employeeId || emp.id}')"><i class="fas fa-play"></i> Onboarding</button>
              <button class="btn btn-secondary btn-small" onclick="viewDetails('${emp.employeeId || emp.id}')"><i class="fas fa-eye"></i> Detalhes</button>
              <button class="btn btn-small" style="background:#f44336" onclick="removeEmployee('${emp.employeeId || emp.id}')"><i class="fas fa-trash"></i> Remover</button>
            </div>
          </div>
        `;
      }).join('');
    }

    /* =================== UI HANDLERS =================== */
    function setupEventListeners(){
      document.getElementById('searchInput').addEventListener('input', filterEmployees);
      document.getElementById('statusFilter').addEventListener('change', filterEmployees);
      document.getElementById('addEmployeeForm').addEventListener('submit', handleAddEmployee);
      document.getElementById('addEmployeeModal').addEventListener('click', (e)=>{ if(e.target===e.currentTarget) closeAddEmployeeModal(); });
    }

    function filterEmployees(){
      const term = document.getElementById('searchInput').value.toLowerCase();
      const status = document.getElementById('statusFilter').value;
      const filtered = employees.filter(e=>{
        const matchesSearch = (e.name||'').toLowerCase().includes(term) || (e.position||'').toLowerCase().includes(term);
        const pct = derivePct(e);
        const stt = e.status || computeStatus(pct);
        const matchesStatus = !status || stt === status;
        return matchesSearch && matchesStatus;
      });
      renderEmployees(filtered);
    }

    function openAddEmployeeModal(){ document.getElementById('addEmployeeModal').style.display='flex'; }
    function closeAddEmployeeModal(){
      document.getElementById('addEmployeeModal').style.display='none';
      document.getElementById('addEmployeeForm').reset();
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('employeeStartDate').value = today;
    }

    async function handleAddEmployee(e){
      e.preventDefault();
      const record = {
        id: 'emp-' + Date.now(),
        name: document.getElementById('employeeName').value.trim(),
        position: document.getElementById('employeePosition').value.trim(),
        startDate: document.getElementById('employeeStartDate').value,
        manager: document.getElementById('employeeManager').value.trim(),
        email: document.getElementById('employeeEmail').value.trim(),
        status: 'pending',
        progress: 0
      };

      // GAS aceita "record" OU "employee"
      const payload = { type:'employees-upsert', record };

      try{
        const res = await fetch(GAS_WEB_APP_URL, { method:'POST', headers:{ 'Content-Type':'text/plain' }, body: JSON.stringify(payload) });
        if(!res.ok) throw new Error('Falha HTTP ao salvar');
        const out = await res.json();
        if(!out.ok) throw new Error(out.error || 'Erro ao salvar');

        const newEmp = normalizeEmployee(record);
        employees.push(newEmp);
        saveEmployeesLocal(employees);
        renderEmployees();
        closeAddEmployeeModal();
        toast('Funcionário salvo (Sheets) e sincronizado.');
      }catch(err){
        console.error(err);
        const newEmp = normalizeEmployee(record);
        employees.push(newEmp);
        saveEmployeesLocal(employees);
        renderEmployees();
        closeAddEmployeeModal();
        toast('Sem backend. Salvo apenas neste dispositivo.');
      }
    }

    function startOnboarding(employeeId){
      const emp = employees.find(e => (e.employeeId||e.id) === employeeId);
      if(!emp) return;
      const pct = derivePct(emp);
      const legacyEmp = { id: employeeId, name: emp.name, position: emp.position, startDate: emp.startDate, manager: emp.manager, progress: pct };
      localStorage.setItem('currentEmployee', JSON.stringify(legacyEmp));
      window.location.href = 'onboarding.html';
    }

    function viewDetails(employeeId){
      const e = employees.find(x => (x.employeeId||x.id) === employeeId);
      if(!e) return;
      const pct = derivePct(e);
      const stt = e.status || computeStatus(pct);
      alert(`Detalhes do Funcionário:

Nome: ${e.name}
Cargo: ${e.position}
Data de Início: ${formatDate(e.startDate)}
Gerente: ${e.manager}
E-mail: ${e.email || 'Não informado'}
Status: ${getStatusText(stt)}
Progresso: ${pct}%`);
    }

    function removeEmployee(employeeId){
      if(!confirm('Tem certeza que deseja remover este funcionário desta lista?')) return;
      employees = employees.filter(e => (e.employeeId||e.id) !== employeeId);
      saveEmployeesLocal(employees);
      renderEmployees();
      toast('Removido somente deste dispositivo. (Não remove da planilha)');
    }

    /* =================== HELPERS =================== */
    function formatDate(d){
      if(!d) return '—';
      const dt = new Date(d);
      if(isNaN(dt.getTime())) return String(d);
      return dt.toLocaleDateString('pt-BR');
    }

    function getStatusText(s){
      const map={ 'pending':'Pendente','in-progress':'Em Andamento','completed':'Concluído' };
      return map[s] || s || 'Pendente';
    }

    function toast(msg){
      const t=document.getElementById('toast');
      t.textContent=msg; t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 2200);
    }

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</body>
</html>
