<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <!-- Pinch habilitado; nada de zoom forçado -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5"/>
  <title>Sistema de Onboarding - Novo Funcionário</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{margin:0;padding:0;background:#1a1a1a;color:#eaeaea;font-family:
      'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;line-height:1.6}
    body{overflow-x:hidden} /* impede scroll lateral no mobile, como no arquivo de referência */

    /* container que segura o wrapper escalado e dá altura correta à página */
    #page{position:relative;width:100%;min-height:100vh;overflow-x:hidden}

    /* wrapper é o layout desktop de 1280p que será escalado no mobile */
    #wrapper{width:1280px;margin:0 auto;transform-origin:top left}

    .container{max-width:1200px;margin:0 auto;padding:0 20px}

    /* Header */
    .header{background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%);color:#fff;padding:40px 30px;text-align:center;border-radius:15px 15px 0 0;box-shadow:0 4px 20px rgba(0,0,0,.3);position:relative;overflow:hidden}
    .header::before{content:
      '';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.05) 0%,transparent 70%);animation:rotate 30s linear infinite}
    @keyframes rotate{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    .header-content{position:relative;z-index:1}
    .header-icon{font-size:3em;margin-bottom:20px;color:#4CAF50}
    .header h1{font-size:2.2em;font-weight:700;margin-bottom:10px}
    .header h2{font-size:1.4em;font-weight:400;margin-bottom:15px;color:#ecf0f1}
    .header p{font-size:1.05em;opacity:.9;max-width:700px;margin:0 auto}

    .main-container{background:#2a2a2a;border-radius:0 0 15px 15px;box-shadow:0 4px 20px rgba(0,0,0,.3);padding:30px}
    .card{background:#3a3a3a;border-radius:12px;padding:25px;margin-bottom:30px;box-shadow:0 4px 15px rgba(0,0,0,.2)}
    .card h3{display:flex;align-items:center;gap:10px;margin-bottom:15px}

    .employee-info{border-left:4px solid #4CAF50}
    .employee-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;color:#e0e0e0}
    .employee-details div{background:#4a4a4a;padding:10px 15px;border-radius:8px}
    .employee-details strong{color:#4CAF50}

    .progress-overview{background:#3a3a3a;border-radius:12px;padding:25px;margin-bottom:30px;border-left:4px solid #2196F3;box-shadow:0 4px 15px rgba(0,0,0,.2)}
    .progress-overview h3{color:#2196F3;margin-bottom:15px;display:flex;align-items:center;gap:10px}
    .progress-bar-container{background:#4a4a4a;border-radius:10px;height:20px;overflow:hidden;margin-bottom:10px}
    .progress-bar{background:linear-gradient(90deg,#4CAF50,#45a049);height:100%;width:0%;transition:width .5s ease;border-radius:10px}
    .progress-text{color:#e0e0e0;text-align:center;font-weight:600}

    /* Steps */
    .step-section{background:#3a3a3a;border-radius:12px;margin-bottom:25px;box-shadow:0 4px 15px rgba(0,0,0,.2);border-left:4px solid #FF9800;overflow:hidden}
    .step-header{background:linear-gradient(135deg,#FF9800 0%,#F57C00 100%);color:#fff;padding:20px 25px;display:flex;align-items:center;gap:15px;cursor:pointer;transition:all .3s ease}
    .step-header:hover{background:linear-gradient(135deg,#F57C00 0%,#E65100 100%)}
    .step-header i{font-size:1.5em}
    .step-header h3{font-size:1.1em;font-weight:700;margin:0;flex:1}
    .step-toggle{font-size:1.2em;transition:transform .3s ease}
    .step-content{padding:22px;display:none}
    .step-content.active{display:block}
    .step-badge{font-size:.78rem;font-weight:800;padding:4px 10px;border-radius:999px;line-height:1;background:#666;color:#fff;opacity:.95}
    .step-header.done .step-badge{background:#2e7d32}
    .step-header.done{background:linear-gradient(135deg,#2e7d32 0%,#1b5e20 100%) !important}

    .checklist-item{background:#4a4a4a;border:2px solid #555;border-radius:10px;padding:14px 16px;margin-bottom:12px;display:flex;align-items:flex-start;gap:14px;cursor:pointer;transition:all .25s ease}
    .checklist-item:hover{border-color:#4CAF50;background:#525252}
    .checklist-item.completed{background:#2e5233;border-color:#4CAF50}
    .checklist-item.completed .item-text{text-decoration:line-through;opacity:.85}
    .checklist-item.disabled{opacity:.5;cursor:not-allowed;filter:grayscale(.25)}
    .checkbox-custom{width:22px;height:22px;border:2px solid #777;border-radius:6px;position:relative;flex-shrink:0;margin-top:2px}
    .checklist-item.completed .checkbox-custom{background:#4CAF50;border-color:#4CAF50}
    .checklist-item.completed .checkbox-custom::after{content:
      '✓';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-weight:800;font-size:15px}
    .item-text{color:#e0e0e0;font-size:1rem;flex:1}
    .item-note{font-size:.92rem;color:#cfcfcf;margin-top:6px;font-style:italic}

    .action-buttons{display:flex;gap:14px;justify-content:center;margin-top:26px;padding-top:18px;border-top:2px solid #555;flex-wrap:wrap}
    .btn{display:flex;align-items:center;gap:10px;padding:12px 20px;border:none;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer;text-decoration:none;transition:all .3s ease}
    .btn-primary{background:linear-gradient(135deg,#4CAF50 0%,#45a049 100%);color:#fff;box-shadow:0 4px 15px rgba(76,175,80,.3)}
    .btn-secondary{background:linear-gradient(135deg,#2196F3 0%,#1976D2 100%);color:#fff;box-shadow:0 4px 15px rgba(33,150,243,.3)}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.3)}

    .toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%);background:#323232;color:#fff;padding:10px 16px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:9999}
    .toast.show{opacity:1}

    .fade-in{animation:fadeIn .5s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

    /* Avaliação (restaurado) */
    .evaluation-container{display:none;margin-top:15px;padding:15px;background:#444;border-radius:10px;text-align:left;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
    .evaluation-container h4{margin-bottom:12px;color:#fff;font-weight:700}
    .stars{display:flex;gap:10px;margin-bottom:8px}
    .star{
      width:36px;height:36px;border:2px solid #888;border-radius:10px;
      cursor:pointer;display:flex;align-items:center;justify-content:center;
      font-size:1rem;color:#ccc;transition:.2s;background:#3a3a3a
    }
    .star:hover{transform:translateY(-1px)}
    .star.selected{background:#4CAF50;border-color:#4CAF50;color:#fff}
    .eval-note{margin-top:2px;font-size:.9rem;color:#ddd;opacity:.85}

    /* Overlay loading (boot + salvar/espera liberação) */
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.72); display:none; align-items:center; justify-content:center; z-index:2000}
    .overlay .box{background:#2a2a2a; border:1px solid #555; border-radius:12px; padding:22px 26px; color:#e0e0e0; box-shadow:0 12px 28px rgba(0,0,0,.45); text-align:center; min-width:300px}
    .overlay .spinner{font-size:22px;margin-right:10px}
    .overlay .sub{display:block;margin-top:8px;color:#cfcfcf;font-size:.95rem}

    /* Estilos para mensagens de erro */
    .error-message{background:#d32f2f;color:#fff;padding:15px;border-radius:8px;margin:10px 0;text-align:center}
    .warning-message{background:#f57c00;color:#fff;padding:15px;border-radius:8px;margin:10px 0;text-align:center}
  </style>
</head>
<body>
  <div id="page">
    <div id="wrapper">
      <div class="container">
        <header class="header">
          <div class="header-content">
            <i class="fas fa-route header-icon"></i>
            <h1>SISTEMA DE ONBOARDING</h1>
            <h2>Jornada do Novo Funcionário</h2>
            <p>Acompanhe o progresso e marque as etapas concluídas. Para avançar, conclua as tarefas, avalie a etapa e <b>salve o progresso</b>.</p>
          </div>
        </header>

        <div class="main-container">
          <!-- Dados do funcionário -->
          <section class="card employee-info">
            <h3><i class="fas fa-user"></i> Informações do Funcionário</h3>
            <div class="employee-details">
              <div><strong>Nome:</strong> <span id="employeeName">—</span></div>
              <div><strong>Cargo:</strong> <span id="employeePosition">—</span></div>
              <div><strong>Data de Início:</strong> <span id="startDate">—</span></div>
              <div><strong>Gerente:</strong> <span id="managerName">—</span></div>
            </div>
          </section>

          <!-- Progresso -->
          <section class="card progress-overview">
            <h3><i class="fas fa-chart-line"></i> Progresso Geral</h3>
            <div class="progress-bar-container"><div id="progressBar" class="progress-bar"></div></div>
            <div id="progressText" class="progress-text">0% concluído (0 de 0 tarefas)</div>
          </section>

          <!-- Etapas -->
          <section class="step-section">
            <div class="step-header" onclick="toggleStep('step1')">
              <i class="fas fa-user-tie"></i><h3>1º Passo - Gerente.</h3>
              <span class="step-badge">Em andamento</span>
              <i id="toggle1" class="fas fa-chevron-down step-toggle"></i>
            </div>
            <div id="step1" class="step-content">
              <div class="checklist-item" data-task-id="1.1" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">1.1 - Anúncio de vaga</div></div></div>
              <div class="checklist-item" data-task-id="1.2" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">1.2 - Recebimento de currículo</div></div></div>
              <div class="checklist-item" data-task-id="1.3" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">1.3 - Compartilhar com Amanda e buscar (Informações)</div></div></div>
              <div class="checklist-item" data-task-id="1.4" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">1.4 - Marcar entrevista</div></div></div>
              <div class="checklist-item" data-task-id="1.5" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">1.5 - Compartilhar com Silvana para tirar mais uma opinião sobre contratação.</div></div></div>
              <div class="checklist-item" data-task-id="1.6" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">1.6 - Validar com Jose Eduardo</div></div></div>
              <div class="checklist-item" data-task-id="1.7" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">1.7 - Acionar Amanda para processo. (Registro + Linx + OTO + Academia Hering.)</div></div></div>
              <div class="evaluation-container" id="eval-step1">
                <h4>Avaliação desta etapa</h4>
                <div class="stars"><div class="star" data-value="1">1</div><div class="star" data-value="2">2</div><div class="star" data-value="3">3</div><div class="star" data-value="4">4</div><div class="star" data-value="5">5</div></div>
                <div class="eval-note">Escolha uma nota de 1 a 5.</div>
              </div>
            </div>
          </section>

          <section class="step-section">
            <div class="step-header" onclick="toggleStep('step2')">
              <i class="fas fa-calendar-day"></i><h3>2º Passo - Primeiro dia de Trabalho.</h3>
              <span class="step-badge">Em andamento</span>
              <i id="toggle2" class="fas fa-chevron-down step-toggle"></i>
            </div>
            <div id="step2" class="step-content">
              <div class="checklist-item" data-task-id="2.1" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">2.1 - Fazer integração na empresa</div></div></div>
              <div class="checklist-item" data-task-id="2.2" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">2.2 - Apresentar todas Ferramentas</div></div></div>
              <div class="checklist-item" data-task-id="2.3" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">2.3 - Apresentar todo estoque</div></div></div>
              <div class="checklist-item" data-task-id="2.4" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">2.4 - Apresentar chão de loja.</div></div></div>
              <div class="evaluation-container" id="eval-step2">
                <h4>Avaliação desta etapa</h4>
                <div class="stars"><div class="star" data-value="1">1</div><div class="star" data-value="2">2</div><div class="star" data-value="3">3</div><div class="star" data-value="4">4</div><div class="star" data-value="5">5</div></div>
                <div class="eval-note">Escolha uma nota de 1 a 5.</div>
              </div>
            </div>
          </section>

          <section class="step-section">
            <div class="step-header" onclick="toggleStep('step3')">
              <i class="fas fa-graduation-cap"></i><h3>3º Passo - Segundo Dia.</h3>
              <span class="step-badge">Em andamento</span>
              <i id="toggle3" class="fas fa-chevron-down step-toggle"></i>
            </div>
            <div id="step3" class="step-content">
              <div class="checklist-item" data-task-id="3.1" onclick="onTaskClick(event,this)">
                <div class="checkbox-custom"></div>
                <div>
                  <div class="item-text">3.1 - Prática com ferramentas e Loja. (Academia Hering, Indeva e Oto)</div>
                  <div class="item-note">Somente avançar desse passo após completar no Academia Hering as agendas de Boa Vindas, Atendimento 360 e Produto.</div>
                </div>
              </div>
              <div class="evaluation-container" id="eval-step3">
                <h4>Avaliação desta etapa</h4>
                <div class="stars"><div class="star" data-value="1">1</div><div class="star" data-value="2">2</div><div class="star" data-value="3">3</div><div class="star" data-value="4">4</div><div class="star" data-value="5">5</div></div>
                <div class="eval-note">Escolha uma nota de 1 a 5.</div>
              </div>
            </div>
          </section>

          <section class="step-section">
            <div class="step-header" onclick="toggleStep('step4')">
              <i class="fas fa-layer-group"></i><h3>4º Passo - Terceiro dia.</h3>
              <span class="step-badge">Em andamento</span>
              <i id="toggle4" class="fas fa-chevron-down step-toggle"></i>
            </div>
            <div id="step4" class="step-content">
              <div class="checklist-item" data-task-id="4.1" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">4.1 - Conhecer Estoque, conhecer ranking de produtos e sua importância no portifólio das vendas</div></div></div>
              <div class="evaluation-container" id="eval-step4">
                <h4>Avaliação desta etapa</h4>
                <div class="stars"><div class="star" data-value="1">1</div><div class="star" data-value="2">2</div><div class="star" data-value="3">3</div><div class="star" data-value="4">4</div><div class="star" data-value="5">5</div></div>
                <div class="eval-note">Escolha uma nota de 1 a 5.</div>
              </div>
            </div>
          </section>

          <section class="step-section">
            <div class="step-header" onclick="toggleStep('step5')">
              <i class="fas fa-calendar-week"></i><h3>5º Passo - Quarto, Quinto e Sexto dia.</h3>
              <span class="step-badge">Em andamento</span>
              <i id="toggle5" class="fas fa-chevron-down step-toggle"></i>
            </div>
            <div id="step5" class="step-content">
              <div class="checklist-item" data-task-id="5.1" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">5.1 - Iniciar atendimento com acompanhamento 100% da gerente.</div></div></div>
              <div class="evaluation-container" id="eval-step5">
                <h4>Avaliação desta etapa</h4>
                <div class="stars"><div class="star" data-value="1">1</div><div class="star" data-value="2">2</div><div class="star" data-value="3">3</div><div class="star" data-value="4">4</div><div class="star" data-value="5">5</div></div>
                <div class="eval-note">Escolha uma nota de 1 a 5.</div>
              </div>
            </div>
          </section>

          <section class="step-section">
            <div class="step-header" onclick="toggleStep('step6')">
              <i class="fas fa-calendar-alt"></i><h3>6º Passo - Sétimo dia.</h3>
              <span class="step-badge">Em andamento</span>
              <i id="toggle6" class="fas fa-chevron-down step-toggle"></i>
            </div>
            <div id="step6" class="step-content">
              <div class="checklist-item" data-task-id="6.1" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">6.1 - Iniciar atendimento com acompanhamento 50% da gerente.</div></div></div>
              <div class="evaluation-container" id="eval-step6">
                <h4>Avaliação desta etapa</h4>
                <div class="stars"><div class="star" data-value="1">1</div><div class="star" data-value="2">2</div><div class="star" data-value="3">3</div><div class="star" data-value="4">4</div><div class="star" data-value="5">5</div></div>
                <div class="eval-note">Escolha uma nota de 1 a 5.</div>
              </div>
            </div>
          </section>

          <section class="step-section">
            <div class="step-header" onclick="toggleStep('step7')">
              <i class="fas fa-trophy"></i><h3>7º Passo - Oitavo dia.</h3>
              <span class="step-badge">Em andamento</span>
              <i id="toggle7" class="fas fa-chevron-down step-toggle"></i>
            </div>
            <div id="step7" class="step-content">
              <div class="checklist-item" data-task-id="7.1" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">7.1 - Iniciar atendimento com acompanhamento 25% da gerente.</div></div></div>
              <div class="evaluation-container" id="eval-step7">
                <h4>Avaliação desta etapa</h4>
                <div class="stars"><div class="star" data-value="1">1</div><div class="star" data-value="2">2</div><div class="star" data-value="3">3</div><div class="star" data-value="4">4</div><div class="star" data-value="5">5</div></div>
                <div class="eval-note">Escolha uma nota de 1 a 5.</div>
              </div>
            </div>
          </section>

          <section class="step-section">
            <div class="step-header" onclick="toggleStep('step8')">
              <i class="fas fa-star"></i><h3>8º Passo - Nono dia.</h3>
              <span class="step-badge">Em andamento</span>
              <i id="toggle8" class="fas fa-chevron-down step-toggle"></i>
            </div>
            <div id="step8" class="step-content">
              <div class="checklist-item" data-task-id="8.1" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">8.1 - Iniciar atendimento sem acompanhamento da gerente.</div></div></div>
              <div class="evaluation-container" id="eval-step8">
                <h4>Avaliação desta etapa</h4>
                <div class="stars"><div class="star" data-value="1">1</div><div class="star" data-value="2">2</div><div class="star" data-value="3">3</div><div class="star" data-value="4">4</div><div class="star" data-value="5">5</div></div>
                <div class="eval-note">Escolha uma nota de 1 a 5.</div>
              </div>
            </div>
          </section>

          <!-- Botões de ação -->
          <div class="action-buttons">
            <button id="saveBtn" class="btn btn-primary" onclick="onSaveClick()">
              <i class="fas fa-save"></i> Salvar Progresso
            </button>
            <button class="btn btn-secondary" onclick="generateReportTXT()">
              <i class="fas fa-download"></i> Baixar Relatório
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay de carregamento -->
  <div id="overlay" class="overlay">
    <div class="box">
      <div><i class="fas fa-spinner fa-spin spinner"></i><span id="overlayText">Carregando...</span></div>
      <small id="overlaySubtext" class="sub">Aguarde um momento</small>
    </div>
  </div>

  <!-- Toast para notificações -->
  <div id="toast" class="toast"></div>

  <script>
    // ====== CONFIGURAÇÕES E VARIÁVEIS GLOBAIS ======
    const FEEDBACK_AUTO_SEND_ON_COMPLETE = true;
    const ORDERED_TASK_IDS = ['1.1','1.2','1.3','1.4','1.5','1.6','1.7','2.1','2.2','2.3','2.4','3.1','4.1','5.1','6.1','7.1','8.1'];
    const STEPS = [
      {id:1,title:'1º Passo - Gerente.'},
      {id:2,title:'2º Passo - Primeiro dia de Trabalho.'},
      {id:3,title:'3º Passo - Segundo Dia.'},
      {id:4,title:'4º Passo - Terceiro dia.'},
      {id:5,title:'5º Passo - Quarto, Quinto e Sexto dia.'},
      {id:6,title:'6º Passo - Sétimo dia.'},
      {id:7,title:'7º Passo - Oitavo dia.'},
      {id:8,title:'8º Passo - Nono dia.'}
    ];

    // ====== VARIÁVEIS GLOBAIS ======
    let employeeData = {id:'',name:'Funcionário Exemplo',position:'Cargo Exemplo',startDate:'01/01/2024',manager:'Gerente Exemplo',email:''};
    let lockedIndex = 0;
    let lastSavedCheckpoint = 0;

    // ====== FUNÇÕES DE INICIALIZAÇÃO ======
    document.addEventListener('DOMContentLoaded', function() {
      try {
        boot();
      } catch (error) {
        console.error('Erro durante a inicialização:', error);
        setOverlay(false);
        showToast('Erro durante a inicialização. Verifique o console para mais detalhes.');
      }
    });

    async function boot() {
      try {
        setOverlay(true, 'Inicializando sistema...', 'Carregando dados do funcionário');
        
        // Carrega dados do funcionário com tratamento de erro
        try {
          loadCurrentEmployee();
        } catch (error) {
          console.warn('Erro ao carregar dados do funcionário:', error);
          // Continua com dados padrão se houver erro
        }

        // Inicializa a interface
        initializeInterface();
        
        // Simula um pequeno delay para mostrar o carregamento
        await new Promise(resolve => setTimeout(resolve, 1000));
        
      } catch (error) {
        console.error('Erro durante o boot:', error);
        showToast('Erro durante a inicialização. Sistema carregado com configurações padrão.');
      } finally {
        // Sempre remove o overlay, mesmo se houver erro
        setOverlay(false);
      }
    }

    function initializeInterface() {
      try {
        // Inicializa componentes da interface
        setupEventListeners();
        updateProgressBar();
        updateStepStatuses();
        restoreCompletedTasks();
        restoreRatingsUI();
        applySequentialLocking();
        
        // Aplica escala para mobile
        scheduleScale();
      } catch (error) {
        console.error('Erro ao inicializar interface:', error);
      }
    }

    function setupEventListeners() {
      // Event listeners para avaliações
      document.querySelectorAll('.star').forEach(star => {
        star.addEventListener('click', function() {
          const stepId = this.closest('.evaluation-container').id.replace('eval-step', '');
          const value = parseInt(this.dataset.value, 10);
          setRating(stepId, value);
        });
      });
    }

    // ====== FUNÇÕES DE OVERLAY ======
    function setOverlay(show, mainText = 'Carregando...', subText = 'Aguarde um momento') {
      try {
        const overlay = document.getElementById('overlay');
        const overlayText = document.getElementById('overlayText');
        const overlaySubtext = document.getElementById('overlaySubtext');
        
        if (!overlay) {
          console.warn('Elemento overlay não encontrado');
          return;
        }
        
        if (show) {
          if (overlayText) overlayText.textContent = mainText;
          if (overlaySubtext) overlaySubtext.textContent = subText;
          overlay.style.display = 'flex';
        } else {
          overlay.style.display = 'none';
        }
      } catch (error) {
        console.error('Erro ao controlar overlay:', error);
      }
    }

    // ====== FUNÇÕES DE TOAST ======
    function showToast(message, duration = 3000) {
      try {
        const toast = document.getElementById('toast');
        if (!toast) return;
        
        toast.textContent = message;
        toast.classList.add('show');
        
        setTimeout(() => {
          toast.classList.remove('show');
        }, duration);
      } catch (error) {
        console.error('Erro ao mostrar toast:', error);
      }
    }

    // ====== FUNÇÕES DE ETAPAS ======
    function toggleStep(stepId) {
      try {
        const content = document.getElementById(stepId);
        const toggle = document.getElementById('toggle' + stepId.replace('step', ''));
        
        if (!content) return;
        
        const isActive = content.classList.contains('active');
        
        // Fecha todas as outras etapas
        document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.step-toggle').forEach(el => el.style.transform = 'rotate(0deg)');
        
        if (!isActive) {
          content.classList.add('active');
          if (toggle) toggle.style.transform = 'rotate(180deg)';
          
          // Mostra avaliação se todas as tarefas da etapa estiverem concluídas
          const stepNumber = stepId.replace('step', '');
          if (isStepCompleted(stepNumber)) {
            showEvaluation(stepNumber);
          }
        }
      } catch (error) {
        console.error('Erro ao alternar etapa:', error);
      }
    }

    function isStepCompleted(stepNumber) {
      try {
        const stepTasks = ORDERED_TASK_IDS.filter(id => id.startsWith(stepNumber + '.'));
        const completed = getCompletedTaskIds();
        return stepTasks.every(taskId => completed.includes(taskId));
      } catch (error) {
        console.error('Erro ao verificar se etapa está completa:', error);
        return false;
      }
    }

    function showEvaluation(stepId) {
      try {
        const evalContainer = document.getElementById('eval-step' + stepId);
        if (evalContainer) {
          evalContainer.style.display = 'block';
        }
      } catch (error) {
        console.error('Erro ao mostrar avaliação:', error);
      }
    }

    // ====== FUNÇÕES DE TAREFAS ======
    function onTaskClick(event, element) {
      try {
        event.preventDefault();
        
        if (element.classList.contains('disabled')) {
          showToast('Esta tarefa ainda não está disponível.');
          return;
        }
        
        const taskId = element.dataset.taskId;
        if (!taskId) return;
        
        const isCompleted = element.classList.contains('completed');
        
        if (isCompleted) {
          removeCompletedTask(taskId);
          element.classList.remove('completed');
        } else {
          addCompletedTask(taskId);
          element.classList.add('completed');
        }
        
        updateProgressBar();
        updateStepStatuses();
        applySequentialLocking();
        
        // Verifica se deve mostrar avaliação
        const stepNumber = taskId.split('.')[0];
        if (isStepCompleted(stepNumber)) {
          showEvaluation(stepNumber);
        }
      } catch (error) {
        console.error('Erro ao processar clique na tarefa:', error);
      }
    }

    function getCompletedTaskIds() {
      try {
        const stored = localStorage.getItem('completedTasks');
        return stored ? JSON.parse(stored) : [];
      } catch (error) {
        console.error('Erro ao obter tarefas completadas:', error);
        return [];
      }
    }

    function addCompletedTask(taskId) {
      try {
        const completed = getCompletedTaskIds();
        if (!completed.includes(taskId)) {
          completed.push(taskId);
          localStorage.setItem('completedTasks', JSON.stringify(completed));
        }
      } catch (error) {
        console.error('Erro ao adicionar tarefa completada:', error);
      }
    }

    function removeCompletedTask(taskId) {
      try {
        const completed = getCompletedTaskIds();
        const index = completed.indexOf(taskId);
        if (index > -1) {
          completed.splice(index, 1);
          localStorage.setItem('completedTasks', JSON.stringify(completed));
        }
      } catch (error) {
        console.error('Erro ao remover tarefa completada:', error);
      }
    }

    function restoreCompletedTasks() {
      try {
        const completed = getCompletedTaskIds();
        completed.forEach(taskId => {
          const element = document.querySelector(`[data-task-id="${taskId}"]`);
          if (element) {
            element.classList.add('completed');
          }
        });
      } catch (error) {
        console.error('Erro ao restaurar tarefas completadas:', error);
      }
    }

    // ====== FUNÇÕES DE PROGRESSO ======
    function updateProgressBar() {
      try {
        const total = ORDERED_TASK_IDS.length;
        const completed = getCompletedTaskIds().length;
        const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
        
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        
        if (progressBar) {
          progressBar.style.width = percentage + '%';
        }
        
        if (progressText) {
          progressText.textContent = `${percentage}% concluído (${completed} de ${total} tarefas)`;
        }
      } catch (error) {
        console.error('Erro ao atualizar barra de progresso:', error);
      }
    }

    function updateStepStatuses() {
      try {
        STEPS.forEach(step => {
          const stepTasks = ORDERED_TASK_IDS.filter(id => id.startsWith(step.id + '.'));
          const completed = getCompletedTaskIds();
          const completedInStep = stepTasks.filter(taskId => completed.includes(taskId)).length;
          
          const header = document.querySelector(`#step${step.id}`).previousElementSibling;
          const badge = header.querySelector('.step-badge');
          
          if (completedInStep === stepTasks.length) {
            header.classList.add('done');
            if (badge) badge.textContent = 'Concluído';
          } else {
            header.classList.remove('done');
            if (badge) badge.textContent = 'Em andamento';
          }
        });
      } catch (error) {
        console.error('Erro ao atualizar status das etapas:', error);
      }
    }

    function applySequentialLocking() {
      try {
        const completed = getCompletedTaskIds();
        
        ORDERED_TASK_IDS.forEach((taskId, index) => {
          const element = document.querySelector(`[data-task-id="${taskId}"]`);
          if (!element) return;
          
          const isCompleted = completed.includes(taskId);
          const shouldBeEnabled = index <= lockedIndex || isCompleted;
          
          if (shouldBeEnabled) {
            element.classList.remove('disabled');
          } else {
            element.classList.add('disabled');
          }
        });
      } catch (error) {
        console.error('Erro ao aplicar bloqueio sequencial:', error);
      }
    }

    function computeContiguousCompletedIndex() {
      try {
        const completed = getCompletedTaskIds();
        let index = 0;
        
        for (let i = 0; i < ORDERED_TASK_IDS.length; i++) {
          if (completed.includes(ORDERED_TASK_IDS[i])) {
            index = i;
          } else {
            break;
          }
        }
        
        return index;
      } catch (error) {
        console.error('Erro ao computar índice contíguo:', error);
        return 0;
      }
    }

    function checkpointStepIndex() {
      try {
        const completed = getCompletedTaskIds();
        let lastCompletedIndex = -1;
        
        for (let i = 0; i < ORDERED_TASK_IDS.length; i++) {
          if (completed.includes(ORDERED_TASK_IDS[i])) {
            lastCompletedIndex = i;
          }
        }
        
        return lastCompletedIndex;
      } catch (error) {
        console.error('Erro ao obter checkpoint:', error);
        return -1;
      }
    }

    function lastCompletedStep() {
      try {
        const completed = getCompletedTaskIds();
        let lastStep = {stepNumber: 0, title: 'Nenhuma etapa concluída'};
        
        for (let i = ORDERED_TASK_IDS.length - 1; i >= 0; i--) {
          if (completed.includes(ORDERED_TASK_IDS[i])) {
            const stepNumber = parseInt(ORDERED_TASK_IDS[i].split('.')[0]);
            const step = STEPS.find(s => s.id === stepNumber);
            if (step) {
              lastStep = {stepNumber: step.id, title: step.title};
              break;
            }
          }
        }
        
        return lastStep;
      } catch (error) {
        console.error('Erro ao obter última etapa completada:', error);
        return {stepNumber: 0, title: 'Erro ao determinar etapa'};
      }
    }

    // ====== FUNÇÕES DE AVALIAÇÃO ======
    function setRating(stepId, value) {
      try {
        const ratings = getRatings();
        ratings[stepId] = value;
        localStorage.setItem('stepRatings', JSON.stringify(ratings));
        
        // Atualiza UI
        const container = document.getElementById('eval-step' + stepId);
        if (container) {
          container.querySelectorAll('.star').forEach(star => {
            const starValue = parseInt(star.dataset.value, 10);
            star.classList.toggle('selected', starValue <= value);
          });
        }
      } catch (error) {
        console.error('Erro ao definir avaliação:', error);
      }
    }

    function getRatings() {
      try {
        const stored = localStorage.getItem('stepRatings');
        return stored ? JSON.parse(stored) : {};
      } catch (error) {
        console.error('Erro ao obter avaliações:', error);
        return {};
      }
    }

    function restoreRatingsUI() {
      try {
        const ratings = getRatings();
        Object.keys(ratings).forEach(stepId => {
          const val = ratings[stepId];
          const container = document.getElementById('eval-step' + stepId);
          if (container) {
            container.querySelectorAll('.star').forEach(star => {
              const starValue = parseInt(star.dataset.value, 10);
              star.classList.toggle('selected', starValue <= val);
            });
          }
        });
      } catch (error) {
        console.error('Erro ao restaurar avaliações:', error);
      }
    }

    // ====== FUNÇÕES DE SALVAMENTO ======
    async function onSaveClick() {
      try {
        setOverlay(true, 'Salvando progresso...', 'Sincronizando dados');
        
        const beforeCheckpoint = checkpointStepIndex();
        const reportText = buildTxtReport();
        
        // Simula salvamento (substitua pela lógica real de salvamento)
        await simulateSave(reportText);
        
        // Atualiza interface
        const newLockedIndex = computeContiguousCompletedIndex();
        lockedIndex = newLockedIndex;
        applySequentialLocking();
        updateStepStatuses();
        updateProgressBar();
        lastSavedCheckpoint = checkpointStepIndex();
        
        // Feedback visual do botão
        const btn = document.getElementById('saveBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Salvo!';
        setTimeout(() => btn.innerHTML = originalText, 1500);
        
        showToast('Progresso salvo com sucesso!');
        
      } catch (error) {
        console.error('Erro ao salvar:', error);
        showToast('Erro ao salvar progresso. Tente novamente.');
      } finally {
        setOverlay(false);
      }
    }

    async function simulateSave(reportText) {
      // Simula uma operação de salvamento assíncrona
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          try {
            // Aqui você colocaria a lógica real de salvamento
            // Por exemplo, enviar para um servidor ou API
            console.log('Dados salvos:', reportText);
            resolve();
          } catch (error) {
            reject(error);
          }
        }, 2000); // Simula 2 segundos de processamento
      });
    }

    function buildTxtReport() {
      try {
        const completed = getCompletedTaskIds();
        const pending = ORDERED_TASK_IDS.filter(id => !completed.includes(id));
        const all = ORDERED_TASK_IDS.length;
        const done = completed.length;
        const pct = all ? Math.round((done / all) * 100) : 0;
        const today = new Date().toLocaleDateString('pt-BR', {timeZone: 'America/Sao_Paulo'});
        const ratings = getRatings();
        
        const lines = [
          'RELATÓRIO DE ONBOARDING', '',
          `Funcionário: ${employeeData.name}`,
          `Cargo: ${employeeData.position}`,
          `Data de Início: ${employeeData.startDate}`,
          `Gerente: ${employeeData.manager}`,
          `Data do Relatório: ${today}`,
          '', '',
          'PROGRESSO GERAL',
          `Total de tarefas: ${all}`,
          `Tarefas concluídas: ${done}`,
          `Percentual: ${pct}%`,
          '', '',
          'TAREFAS CONCLUÍDAS:',
          ...completed.map(id => '✓ ' + getTaskTextById(id)),
          '', '',
          'TAREFAS PENDENTES:',
          ...pending.map(id => '○ ' + getTaskTextById(id)),
          '', '',
          'AVALIAÇÕES POR ETAPA (1–5):',
          ...STEPS.map(s => `- ${s.title}: ${ratings[String(s.id)] ? ratings[String(s.id)] + '/5' : 'sem avaliação'}`)
        ];
        
        return lines.join('\n');
      } catch (error) {
        console.error('Erro ao construir relatório:', error);
        return 'Erro ao gerar relatório';
      }
    }

    function generateReportTXT() {
      try {
        const content = buildTxtReport();
        const blob = new Blob([content], {type: 'text/plain;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const safe = (employeeData.name || 'Funcionario').replace(/\s+/g, '_');
        const iso = new Date().toISOString().slice(0, 10);
        a.href = url;
        a.download = `relatorio_onboarding_${safe}_${iso}.txt`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('Erro ao gerar relatório:', error);
        showToast('Erro ao gerar relatório');
      }
    }

    // ====== FUNÇÕES DE DADOS DO FUNCIONÁRIO ======
    function loadCurrentEmployee() {
      try {
        const stored = localStorage.getItem('currentEmployee');
        if (stored) {
          const parsed = JSON.parse(stored);
          employeeData = {
            id: parsed.id || '',
            name: parsed.name || 'Funcionário Exemplo',
            position: parsed.position || 'Cargo Exemplo',
            startDate: formatDate(parsed.startDate) || '01/01/2024',
            manager: parsed.manager || 'Gerente Exemplo',
            email: parsed.email || ''
          };
        }
        renderEmployeeInfo();
      } catch (error) {
        console.error('Erro ao carregar dados do funcionário:', error);
        // Usa dados padrão em caso de erro
        renderEmployeeInfo();
      }
    }

    function renderEmployeeInfo() {
      try {
        const elements = {
          employeeName: document.getElementById('employeeName'),
          employeePosition: document.getElementById('employeePosition'),
          startDate: document.getElementById('startDate'),
          managerName: document.getElementById('managerName')
        };
        
        if (elements.employeeName) elements.employeeName.textContent = employeeData.name;
        if (elements.employeePosition) elements.employeePosition.textContent = employeeData.position;
        if (elements.startDate) elements.startDate.textContent = employeeData.startDate;
        if (elements.managerName) elements.managerName.textContent = employeeData.manager;
      } catch (error) {
        console.error('Erro ao renderizar informações do funcionário:', error);
      }
    }

    function formatDate(dateString) {
      try {
        if (!dateString) return '';
        const date = new Date(dateString);
        return isNaN(date) ? String(dateString) : date.toLocaleDateString('pt-BR');
      } catch (error) {
        console.error('Erro ao formatar data:', error);
        return String(dateString || '');
      }
    }

    function getTaskTextById(taskId) {
      try {
        const element = document.querySelector(`.checklist-item[data-task-id="${taskId}"] .item-text`);
        return element ? element.textContent.trim() : taskId;
      } catch (error) {
        console.error('Erro ao obter texto da tarefa:', error);
        return taskId;
      }
    }

    // ====== FUNÇÕES DE ESCALA PARA MOBILE ======
    let scaleRaf = null;
    
    function scheduleScale() {
      cancelAnimationFrame(scaleRaf);
      scaleRaf = requestAnimationFrame(applyScale);
    }
    
    function applyScale() {
      try {
        const base = 1280;
        const wrapper = document.getElementById('wrapper');
        const page = document.getElementById('page');
        
        if (!wrapper || !page) return;
        
        const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
        const scale = Math.min(1, vw / base);
        
        wrapper.style.transform = (scale < 1) ? `scale(${scale})` : 'none';
        wrapper.style.marginLeft = (scale < 1) ? '0' : 'auto';
        wrapper.style.marginRight = (scale < 1) ? '0' : 'auto';
        
        const scaledH = wrapper.offsetHeight * (scale < 1 ? scale : 1);
        page.style.height = scaledH + 'px';
      } catch (error) {
        console.error('Erro ao aplicar escala:', error);
      }
    }
    
    window.addEventListener('resize', scheduleScale);
  </script>
</body>
</html>
