<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Onboarding - Novo Funcionário</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;line-height:1.6;color:#eaeaea;background:#1a1a1a;min-height:100vh;padding:20px 0}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}

    /* Header */
    .header{background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%);color:#fff;padding:40px 30px;text-align:center;border-radius:15px 15px 0 0;box-shadow:0 4px 20px rgba(0,0,0,.3);position:relative;overflow:hidden}
    .header::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.05) 0%,transparent 70%);animation:rotate 30s linear infinite}
    @keyframes rotate{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    .header-content{position:relative;z-index:1}
    .header-icon{font-size:3em;margin-bottom:20px;color:#4CAF50}
    .header h1{font-size:2.2em;font-weight:700;margin-bottom:10px}
    .header h2{font-size:1.4em;font-weight:400;margin-bottom:15px;color:#ecf0f1}
    .header p{font-size:1.05em;opacity:.9;max-width:700px;margin:0 auto}

    /* Header actions (Home / Voltar) */
    .header-actions{position:absolute;inset:auto 24px 24px auto;display:flex;gap:10px;z-index:2}
    .btn{display:flex;align-items:center;gap:10px;padding:12px 20px;border:none;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer;text-decoration:none;transition:all .3s ease}
    .btn-primary{background:linear-gradient(135deg,#4CAF50 0%,#45a049 100%);color:#fff;box-shadow:0 4px 15px rgba(76,175,80,.3)}
    .btn-secondary{background:linear-gradient(135deg,#2196F3 0%,#1976D2 100%);color:#fff;box-shadow:0 4px 15px rgba(33,150,243,.3)}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.3)}

    .main-container{background:#2a2a2a;border-radius:0 0 15px 15px;box-shadow:0 4px 20px rgba(0,0,0,.3);padding:30px}
    .card{background:#3a3a3a;border-radius:12px;padding:25px;margin-bottom:30px;box-shadow:0 4px 15px rgba(0,0,0,.2)}
    .card h3{display:flex;align-items:center;gap:10px;margin-bottom:15px}

    .employee-info{border-left:4px solid #4CAF50}
    .employee-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;color:#e0e0e0}
    .employee-details div{background:#4a4a4a;padding:10px 15px;border-radius:8px}
    .employee-details strong{color:#4CAF50}

    .progress-overview{background:#3a3a3a;border-radius:12px;padding:25px;margin-bottom:30px;border-left:4px solid #2196F3;box-shadow:0 4px 15px rgba(0,0,0,.2)}
    .progress-overview h3{color:#2196F3;margin-bottom:15px;display:flex;align-items:center;gap:10px}
    .progress-bar-container{background:#4a4a4a;border-radius:10px;height:20px;overflow:hidden;margin-bottom:10px}
    .progress-bar{background:linear-gradient(90deg,#4CAF50,#45a049);height:100%;width:0%;transition:width .5s ease;border-radius:10px}
    .progress-text{color:#e0e0e0;text-align:center;font-weight:600}

    /* Steps */
    .step-section{background:#3a3a3a;border-radius:12px;margin-bottom:25px;box-shadow:0 4px 15px rgba(0,0,0,.2);border-left:4px solid #FF9800;overflow:hidden}
    .step-header{background:linear-gradient(135deg,#FF9800 0%,#F57C00 100%);color:#fff;padding:20px 25px;display:flex;align-items:center;gap:15px;cursor:pointer;transition:all .3s ease}
    .step-header:hover{background:linear-gradient(135deg,#F57C00 0%,#E65100 100%)}
    .step-header i{font-size:1.5em}
    .step-header h3{font-size:1.1em;font-weight:700;margin:0;flex:1}
    .step-toggle{font-size:1.2em;transition:transform .3s ease}
    .step-content{padding:22px;display:none}
    .step-content.active{display:block}
    .step-badge{font-size:.78rem;font-weight:800;padding:4px 10px;border-radius:999px;line-height:1;background:#666;color:#fff;opacity:.95}
    .step-header.done .step-badge{background:#2e7d32}
    .step-header.done{background:linear-gradient(135deg,#2e7d32 0%,#1b5e20 100%) !important}

    .checklist-item{background:#4a4a4a;border:2px solid #555;border-radius:10px;padding:14px 16px;margin-bottom:12px;display:flex;align-items:flex-start;gap:14px;cursor:pointer;transition:all .25s ease}
    .checklist-item:hover{border-color:#4CAF50;background:#525252}
    .checklist-item.completed{background:#2e5233;border-color:#4CAF50}
    .checklist-item.completed .item-text{text-decoration:line-through;opacity:.85}
    .checklist-item.disabled{opacity:.5;cursor:not-allowed;filter:grayscale(.25)}
    .checkbox-custom{width:22px;height:22px;border:2px solid #777;border-radius:6px;position:relative;flex-shrink:0;margin-top:2px}
    .checklist-item.completed .checkbox-custom{background:#4CAF50;border-color:#4CAF50}
    .checklist-item.completed .checkbox-custom::after{content:'✓';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-weight:800;font-size:15px}
    .item-text{color:#e0e0e0;font-size:1rem;flex:1}
    .item-note{font-size:.92rem;color:#cfcfcf;margin-top:6px;font-style:italic}

    .action-buttons{display:flex;gap:14px;justify-content:center;margin-top:26px;padding-top:18px;border-top:2px solid #555}
    .toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%);background:#323232;color:#fff;padding:10px 16px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:9999}
    .toast.show{opacity:1}

    @media(max-width:768px){.employee-details{grid-template-columns:1fr}.action-buttons{flex-direction:column}}
    .fade-in{animation:fadeIn .5s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

    /* Avaliação */
    .evaluation-container{display:none;margin-top:15px;padding:15px;background:#444;border-radius:10px;text-align:center;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
    .evaluation-container h4{margin-bottom:12px;color:#fff;font-weight:700}
    .stars{display:flex;justify-content:center;gap:10px}
    .star{width:36px;height:36px;border:2px solid #888;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;color:#ccc;transition:.2s}
    .star:hover{transform:translateY(-1px)}
    .star.selected{background:#4CAF50;border-color:#4CAF50;color:#fff}
    .eval-note{margin-top:8px;font-size:.9rem;color:#ddd;opacity:.85}

    /* Overlay loading */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.72); display:none; align-items:center; justify-content:center; z-index:2000
    }
    .overlay .box{
      background:#2a2a2a; border:1px solid #555; border-radius:12px; padding:22px 26px; color:#e0e0e0; box-shadow:0 12px 28px rgba(0,0,0,.45); text-align:center; min-width:280px
    }
    .overlay .spinner{font-size:22px;margin-right:10px}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header-content">
        <i class="fas fa-route header-icon"></i>
        <h1>SISTEMA DE ONBOARDING</h1>
        <h2>Jornada do Novo Funcionário</h2>
        <p>Acompanhe o progresso e marque as etapas concluídas. Para avançar, conclua as tarefas, avalie a etapa e <b>salve o progresso</b>.</p>
      </div>

      <!-- Ações do cabeçalho -->
      <div class="header-actions">
        <a href="home.html" class="btn btn-secondary"><i class="fas fa-home"></i> Home</a>
        <a href="funcionarios.html" class="btn btn-primary"><i class="fas fa-users"></i> Lista</a>
      </div>
    </header>

    <div class="main-container">
      <!-- Dados do funcionário -->
      <section class="card employee-info">
        <h3><i class="fas fa-user"></i> Informações do Funcionário</h3>
        <div class="employee-details">
          <div><strong>Nome:</strong> <span id="employeeName">—</span></div>
          <div><strong>Cargo:</strong> <span id="employeePosition">—</span></div>
          <div><strong>Data de Início:</strong> <span id="startDate">—</span></div>
          <div><strong>Gerente:</strong> <span id="managerName">—</span></div>
        </div>
      </section>

      <!-- Progresso -->
      <section class="card progress-overview">
        <h3><i class="fas fa-chart-line"></i> Progresso Geral</h3>
        <div class="progress-bar-container"><div id="progressBar" class="progress-bar"></div></div>
        <div id="progressText" class="progress-text">0% concluído (0 de 0 tarefas)</div>
      </section>

      <!-- 1 -->
      <section class="step-section">
        <div class="step-header" onclick="toggleStep('step1')">
          <i class="fas fa-user-tie"></i><h3>1º Passo - Gerente.</h3>
          <span class="step-badge">Em andamento</span>
          <i id="toggle1" class="fas fa-chevron-down step-toggle"></i>
        </div>
        <div id="step1" class="step-content">
          <div class="checklist-item" data-task-id="1.1" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">1.1 - Anúncio de vaga</div></div></div>
          <div class="checklist-item" data-task-id="1.2" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">1.2 - Recebimento de currículo</div></div></div>
          <div class="checklist-item" data-task-id="1.3" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">1.3 - Compartilhar com Amanda e buscar (Informações)</div></div></div>
          <div class="checklist-item" data-task-id="1.4" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">1.4 - Marcar entrevista</div></div></div>
          <div class="checklist-item" data-task-id="1.5" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">1.5 - Compartilhar com Silvana para tirar mais uma opinião sobre contratação.</div></div></div>
          <div class="checklist-item" data-task-id="1.6" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">1.6 - Validar com Jose Eduardo</div></div></div>
          <div class="checklist-item" data-task-id="1.7" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">1.7 - Acionar Amanda para processo. (Registro + Linx + OTO + Academia Hering.)</div></div></div>

          <div class="evaluation-container" id="eval-step1">
            <h4>Avaliação desta etapa</h4>
            <div class="stars">
              <div class="star" data-value="1">1</div><div class="star" data-value="2">2</div><div class="star" data-value="3">3</div><div class="star" data-value="4">4</div><div class="star" data-value="5">5</div>
            </div>
            <div class="eval-note">Escolha uma nota de 1 a 5.</div>
          </div>
        </div>
      </section>

      <!-- 2 -->
      <section class="step-section">
        <div class="step-header" onclick="toggleStep('step2')">
          <i class="fas fa-calendar-day"></i><h3>2º Passo - Primeiro dia de Trabalho.</h3>
          <span class="step-badge">Em andamento</span>
          <i id="toggle2" class="fas fa-chevron-down step-toggle"></i>
        </div>
        <div id="step2" class="step-content">
          <div class="checklist-item" data-task-id="2.1" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">2.1 - Fazer integração na empresa</div></div></div>
          <div class="checklist-item" data-task-id="2.2" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">2.2 - Apresentar todas Ferramentas</div></div></div>
          <div class="checklist-item" data-task-id="2.3" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">2.3 - Apresentar todo estoque</div></div></div>
          <div class="checklist-item" data-task-id="2.4" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">2.4 - Apresentar chão de loja.</div></div></div>

          <div class="evaluation-container" id="eval-step2">
            <h4>Avaliação desta etapa</h4>
            <div class="stars">
              <div class="star" data-value="1">1</div><div class="star" data-value="2">2</div><div class="star" data-value="3">3</div><div class="star" data-value="4">4</div><div class="star" data-value="5">5</div>
            </div>
            <div class="eval-note">Escolha uma nota de 1 a 5.</div>
          </div>
        </div>
      </section>

      <!-- 3 -->
      <section class="step-section">
        <div class="step-header" onclick="toggleStep('step3')">
          <i class="fas fa-graduation-cap"></i><h3>3º Passo - Segundo Dia.</h3>
          <span class="step-badge">Em andamento</span>
          <i id="toggle3" class="fas fa-chevron-down step-toggle"></i>
        </div>
        <div id="step3" class="step-content">
          <div class="checklist-item" data-task-id="3.1" onclick="onTaskClick(event,this)">
            <div class="checkbox-custom"></div>
            <div>
              <div class="item-text">3.1 - Prática com ferramentas e Loja. (Academia Hering, Indeva e Oto)</div>
              <div class="item-note">Somente avançar desse passo após completar no Academia Hering as agendas de Boa Vindas, Atendimento 360 e Produto.</div>
            </div>
          </div>

          <div class="evaluation-container" id="eval-step3">
            <h4>Avaliação desta etapa</h4>
            <div class="stars">
              <div class="star" data-value="1">1</div><div class="star" data-value="2">2</div><div class="star" data-value="3">3</div><div class="star" data-value="4">4</div><div class="star" data-value="5">5</div>
            </div>
            <div class="eval-note">Escolha uma nota de 1 a 5.</div>
          </div>
        </div>
      </section>

      <!-- 4 -->
      <section class="step-section">
        <div class="step-header" onclick="toggleStep('step4')">
          <i class="fas fa-layer-group"></i><h3>4º Passo - Terceiro dia.</h3>
          <span class="step-badge">Em andamento</span>
          <i id="toggle4" class="fas fa-chevron-down step-toggle"></i>
        </div>
        <div id="step4" class="step-content">
          <div class="checklist-item" data-task-id="4.1" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">4.1 - Conhecer Estoque, conhecer ranking de produtos e sua importância no portifólio das vendas</div></div></div>

          <div class="evaluation-container" id="eval-step4">
            <h4>Avaliação desta etapa</h4>
            <div class="stars">
              <div class="star" data-value="1">1</div><div class="star" data-value="2">2</div><div class="star" data-value="3">3</div><div class="star" data-value="4">4</div><div class="star" data-value="5">5</div>
            </div>
            <div class="eval-note">Escolha uma nota de 1 a 5.</div>
          </div>
        </div>
      </section>

      <!-- 5 -->
      <section class="step-section">
        <div class="step-header" onclick="toggleStep('step5')">
          <i class="fas fa-calendar-week"></i><h3>5º Passo - Quarto, Quinto e Sexto dia.</h3>
          <span class="step-badge">Em andamento</span>
          <i id="toggle5" class="fas fa-chevron-down step-toggle"></i>
        </div>
        <div id="step5" class="step-content">
          <div class="checklist-item" data-task-id="5.1" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">5.1 - Iniciar atendimento com acompanhamento 100% da gerente.</div></div></div>

          <div class="evaluation-container" id="eval-step5">
            <h4>Avaliação desta etapa</h4>
            <div class="stars">
              <div class="star" data-value="1">1</div><div class="star" data-value="2">2</div><div class="star" data-value="3">3</div><div class="star" data-value="4">4</div><div class="star" data-value="5">5</div>
            </div>
            <div class="eval-note">Escolha uma nota de 1 a 5.</div>
          </div>
        </div>
      </section>

      <!-- 6 -->
      <section class="step-section">
        <div class="step-header" onclick="toggleStep('step6')">
          <i class="fas fa-check-circle"></i><h3>6º Passo - Sétimo dia.</h3>
          <span class="step-badge">Em andamento</span>
          <i id="toggle6" class="fas fa-chevron-down step-toggle"></i>
        </div>
        <div id="step6" class="step-content">
          <div class="checklist-item" data-task-id="6.1" onclick="onTaskClick(event,this)"><div class="checkbox-custom"></div><div><div class="item-text">6.1 - Validação da semana pelo gerente e repassada</div></div></div>

          <div class="evaluation-container" id="eval-step6">
            <h4>Avaliação desta etapa</h4>
            <div class="stars">
              <div class="star" data-value="1">1</div><div class="star" data-value="2">2</div><div class="star" data-value="3">3</div><div class="star" data-value="4">4</div><div class="star" data-value="5">5</div>
            </div>
            <div class="eval-note">Escolha uma nota de 1 a 5.</div>
          </div>
        </div>
      </section>

      <!-- Ações -->
      <div class="action-buttons">
        <button id="saveBtn" type="button" class="btn btn-primary" onclick="onSaveClick()"><i class="fas fa-save"></i>Salvar Progresso</button>
        <button type="button" class="btn btn-secondary" onclick="generateReportTXT()"><i class="fas fa-file-alt"></i>Gerar Relatório (TXT)</button>
      </div>
    </div>
  </div>

  <!-- Overlay Loading -->
  <div id="overlay" class="overlay">
    <div class="box">
      <span class="spinner"><i class="fas fa-circle-notch fa-spin"></i></span>
      Carregando progresso, aguarde…
    </div>
  </div>

  <div id="toast" class="toast">Mensagem</div>

  <script>
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzx7fZB5WPpdAI7nUADWhzWZF83CyTKIl50jkOeJanoPao9t1eecOQ5CrshZksO5A5e/exec';

    // Regras
    const STEPS = [
      { id:1, title:'1º Passo - Gerente.', tasks:['1.1','1.2','1.3','1.4','1.5','1.6','1.7'] },
      { id:2, title:'2º Passo - Primeiro dia de Trabalho.', tasks:['2.1','2.2','2.3','2.4'] },
      { id:3, title:'3º Passo - Segundo Dia.', tasks:['3.1'] },
      { id:4, title:'4º Passo - Terceiro dia.', tasks:['4.1'] },
      { id:5, title:'5º Passo - Quarto, Quinto e Sexto dia.', tasks:['5.1'] },
      { id:6, title:'6º Passo - Sétimo dia.', tasks:['6.1'] }
    ];
    const ORDERED_TASK_IDS = STEPS.flatMap(s=>s.tasks);
    const DEFAULT_LOCKED_IDS = new Set(['1.1','1.2']); // não pode desmarcar no primeiro acesso

    let employeeData = { id:null, name:'—', position:'—', startDate:'—', manager:'—' };
    let lockedIndex = -1;
    let bootPrefilled = false; // sinaliza se marcamos 1.1/1.2 por ser novo (sem registro)
    let ratingsLoaded = false;
    let lastSavedCheckpoint = 0; // para obrigar "Salvar" antes de abrir próxima etapa

    /* ======= Helpers de ratings ======= */
    function ratingsKey(){ return 'ratings:' + (employeeData.id || 'sem_id'); }
    function getRatings(){ try{ return JSON.parse(localStorage.getItem(ratingsKey())||'{}'); }catch{ return {}; } }
    function setRatings(obj){ localStorage.setItem(ratingsKey(), JSON.stringify(obj||{})); }
    function hasRating(stepId){ const r=getRatings(); return !!r[String(stepId)]; }

    function computeContiguousCompletedIndex(){ let idx=-1; for (let i=0;i<ORDERED_TASK_IDS.length;i++){ if(isTaskCompleted(ORDERED_TASK_IDS[i])) idx=i; else break; } return idx; }

    function showOverlay(on){ document.getElementById('overlay').style.display = on ? 'flex' : 'none'; }

    document.addEventListener('DOMContentLoaded', () => {
      showOverlay(true);
      loadCurrentEmployee(); renderEmployeeInfo();

      // UX: pinta (1.1/1.2) como concluído no primeiro carregamento
      prefillIfNew();

      // busca dados reais no backend
      hydrateFromBackend().finally(()=>{
        applySequentialLocking();
        updateProgressBar();
        updateStepStatuses();
        updateEvaluations();
        restoreRatingsUI();
        toggleStep('step1');
        document.querySelectorAll('.step-section').forEach((s,i)=>{ s.style.animationDelay=(i*0.06)+'s'; s.classList.add('fade-in'); });
        // define checkpoint salvo inicial
        lastSavedCheckpoint = checkpointStepIndex();
        showOverlay(false);
      });
    });

    function prefillIfNew(){
      markTaskUI('1.1', true);
      markTaskUI('1.2', true);
      bootPrefilled = true;
      lockedIndex = Math.max(lockedIndex, ORDERED_TASK_IDS.indexOf('1.2'));
    }

    async function hydrateFromBackend(){
      if (!employeeData.id) return;
      try{
        // onboarding
        const url = GAS_WEB_APP_URL + '?type=onboarding-load&id=' + encodeURIComponent(employeeData.id);
        const res = await fetch(url, { cache:'no-store' });
        const out = await res.json();
        if (out && out.ok && out.record){
          bootPrefilled = false;
          ORDERED_TASK_IDS.forEach(id=>markTaskUI(id,false));
          const rec = out.record;
          (rec.completedTasks||[]).forEach(id=>markTaskUI(id,true));
          lockedIndex = (typeof rec.lockedIndex==='number') ? rec.lockedIndex : computeContiguousCompletedIndex();
        }
      }catch(e){ console.warn('onboarding-load falhou:', e); }

      // ratings
      try{
        const url = GAS_WEB_APP_URL + '?type=ratings-load&id=' + encodeURIComponent(employeeData.id);
        const res = await fetch(url, { cache:'no-store' });
        const out = await res.json();
        if (out && out.ok && out.ratings){
          setRatings(out.ratings);
          ratingsLoaded = true;
        }
      }catch(e){ console.warn('ratings-load falhou:', e); }
    }

    function toggleStep(stepDomId){
      const content=document.getElementById(stepDomId);
      const toggle=document.getElementById('toggle'+stepDomId.slice(-1));

      // BLOQUEIO: só permite abrir etapas até o último checkpoint SALVO
      const stepNum = parseInt(stepDomId.replace('step',''),10);
      const cp = lastSavedCheckpoint;       // etapa na qual o progresso foi salvo
      const nextAllowed = cp + 1;           // próxima etapa liberada após salvar

      if (stepNum > nextAllowed){
        showToast('Para abrir esta etapa, conclua as anteriores, avalie e clique em "Salvar Progresso".');
        return;
      }

      document.querySelectorAll('.step-content').forEach(s=>{ if(s.id!==stepDomId) s.classList.remove('active'); });
      document.querySelectorAll('.step-toggle').forEach(i=>{ if(i.id!=='toggle'+stepDomId.slice(-1)) i.style.transform='rotate(0)'; });
      content.classList.toggle('active'); toggle.style.transform=content.classList.contains('active')?'rotate(180deg)':'rotate(0)';
    }

    function onTaskClick(ev, el){
      if (el.classList.contains('disabled')){ showToast('Conclua as etapas anteriores primeiro.'); return; }
      const id=el.dataset.taskId;
      const idx=ORDERED_TASK_IDS.indexOf(id);
      const next=nextAvailableTaskId();
      const isCompleted=el.classList.contains('completed');

      // trava 1.1 e 1.2 quando vieram de regra inicial (ou quando lockedIndex cobrir)
      if ((DEFAULT_LOCKED_IDS.has(id) && bootPrefilled) || (isCompleted && idx<=lockedIndex)){
        showToast(DEFAULT_LOCKED_IDS.has(id) ? 'Essa tarefa é padrão do processo e não pode ser desmarcada.' : 'Essa etapa já foi confirmada anteriormente.');
        return;
      }
      if (!isCompleted && id!==next){ showToast('Você só pode concluir a próxima tarefa disponível.'); return; }

      el.classList.toggle('completed');

      applySequentialLocking();
      updateProgressBar();
      maybeOpenNextStep(id);
      updateStepStatuses();
      updateEvaluations();
    }

    function maybeOpenNextStep(taskId){
      const { stepIndex }=getTaskPosition(taskId);
      const step=STEPS[stepIndex];

      const allTasksDone = step.tasks.every(t=>isTaskCompleted(t));
      if (!allTasksDone) return;

      if (!hasRating(step.id)){
        const c=document.getElementById('eval-step'+step.id);
        if (c){ c.style.display='block'; }
        showToast('Avalie esta etapa para liberar a próxima.');
        return;
      }

      // **Obrigar salvar** antes de abrir a próxima etapa
      const cp = checkpointStepIndex();
      if (cp === stepIndex){
        showToast('Clique em "Salvar Progresso" para liberar a próxima etapa.');
        return;
      }

      if (stepIndex<STEPS.length-1) toggleStep('step'+STEPS[stepIndex+1].id);
    }

    /* ======== Lock / Status ======== */
    function markTaskUI(taskId,completed){ const el=document.querySelector(`.checklist-item[data-task-id="${taskId}"]`); if(el) el.classList.toggle('completed',!!completed); }
    function isTaskCompleted(taskId){ const el=document.querySelector(`.checklist-item[data-task-id="${taskId}"]`); return !!el && el.classList.contains('completed'); }

    function getTaskPosition(taskId){
      const idx=ORDERED_TASK_IDS.indexOf(taskId);
      let acc=0, stepIndex=0, localIndex=idx;
      for(let i=0;i<STEPS.length;i++){
        if(idx<acc+STEPS[i].tasks.length){ stepIndex=i; localIndex=idx-acc; break; }
        acc+=STEPS[i].tasks.length;
      }
      return {stepIndex,localIndex};
    }
    function stepIndexOfTask(taskId){ return getTaskPosition(taskId).stepIndex; }

    function nextAvailableTaskId(){
      for (const step of STEPS){
        for (const id of step.tasks){ if (!isTaskCompleted(id)) return id; }
        if (!hasRating(step.id)) return null;
      }
      return null;
    }

    function applySequentialLocking(){
      const next=nextAvailableTaskId();
      document.querySelectorAll('.checklist-item').forEach(el=>{
        const id=el.dataset.taskId; if(!id) return;
        const idx=ORDERED_TASK_IDS.indexOf(id);
        const mustLock = (idx<=lockedIndex) || (DEFAULT_LOCKED_IDS.has(id) && bootPrefilled);
        if (mustLock){ el.classList.add('disabled'); return; }
        if (isTaskCompleted(id) || (next && id===next)){ el.classList.remove('disabled'); }
        else { el.classList.add('disabled'); }
      });
    }

    function updateProgressBar(){
      const all=ORDERED_TASK_IDS.length;
      const done=ORDERED_TASK_IDS.filter(id=>isTaskCompleted(id)).length;
      const pct=all?Math.round((done/all)*100):0;
      document.getElementById('progressBar').style.width=pct+'%';
      document.getElementById('progressText').textContent=`${pct}% concluído (${done} de ${all} tarefas)`;
    }

    function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2400); }

    function isStepDone(stepObj){
      const tasksOk = stepObj.tasks.every(t=>isTaskCompleted(t));
      const rated   = hasRating(stepObj.id);
      return tasksOk && rated;
    }

    function updateStepStatuses(){
      STEPS.forEach((step)=>{
        const header=document.querySelector(`#step${step.id}`).previousElementSibling; if(!header) return;
        let badge=header.querySelector('.step-badge'); if(!badge){ badge=document.createElement('span'); badge.className='step-badge'; const chev=header.querySelector('.step-toggle'); header.insertBefore(badge,chev); }
        const done=isStepDone(step);
        header.classList.toggle('done',done);
        badge.textContent=done?'Concluído':'Em andamento';
      });
    }

    function updateEvaluations(){
      STEPS.forEach((s)=>{ 
        const tasksOk = s.tasks.every(t=>isTaskCompleted(t));
        const c=document.getElementById('eval-step'+s.id);
        if(c) c.style.display = tasksOk ? 'block' : 'none';
      });
    }

    // Clique nas estrelas → salva local + backend
    document.addEventListener('click', async (e)=>{
      if(!e.target.classList.contains('star')) return;
      const val=parseInt(e.target.dataset.value,10);
      const container=e.target.closest('.evaluation-container');
      const stepId=parseInt(container.id.replace('eval-step',''),10);

      const parent=container.querySelector('.stars');
      parent.querySelectorAll('.star').forEach(st=>{ st.classList.toggle('selected', parseInt(st.dataset.value,10)<=val); });

      const r=getRatings(); r[String(stepId)] = val; setRatings(r);

      try{
        await fetch(GAS_WEB_APP_URL, {
          method:'POST',
          headers:{'Content-Type':'text/plain'},
          body: JSON.stringify({ type:'ratings-save', employeeId: employeeData.id, ratings: r })
        });
      }catch(err){ console.warn('ratings-save falhou', err); }

      applySequentialLocking();
      updateStepStatuses();
    });

    function restoreRatingsUI(){
      const ratings=getRatings();
      Object.keys(ratings).forEach(stepId=>{
        const val=ratings[stepId];
        const stars=document.querySelectorAll('#eval-step'+stepId+' .star');
        stars.forEach(st=>st.classList.toggle('selected', parseInt(st.dataset.value,10)<=val));
      });
    }

    /* ======= SALVAR / RELATÓRIO ======= */
    function getCompletedTaskIds(){ return ORDERED_TASK_IDS.filter(id=>isTaskCompleted(id)); }
    function lastCompletedStep(){
      let last={stepNumber:null, stepTitle:null};
      for (const s of STEPS){
        if (isStepDone(s)) last={stepNumber:s.id, stepTitle:s.title};
        else break;
      }
      return last;
    }

    async function onSaveClick(){
      const reportText = buildTxtReport();
      try{
        const completed = getCompletedTaskIds();
        const pct = ORDERED_TASK_IDS.length ? Math.round((completed.length / ORDERED_TASK_IDS.length) * 100) : 0;
        const stepInfo = lastCompletedStep();
        const newLockedIndex = computeContiguousCompletedIndex();

        const payload = {
          type:'onboarding-save',
          notify:true,
          record:{
            id:employeeData.id,
            name:employeeData.name,
            position:employeeData.position,
            startDate:employeeData.startDate,
            manager:employeeData.manager,
            onboardingData:{ completedTasks:completed, lockedIndex:newLockedIndex },
            progress:pct,
            status: pct===0?'pending':(pct===100?'completed':'in-progress'),
            lastStepNumber: stepInfo.stepNumber,
            lastStepTitle: stepInfo.stepTitle
          },
          reportText
        };

        const res = await fetch(GAS_WEB_APP_URL,{ method:'POST', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(payload)});
        const out = await res.json();
        if(!out.ok) throw new Error(out.error||'Falha ao salvar');

        // garante que as notas também subam
        const r = getRatings();
        await fetch(GAS_WEB_APP_URL, { method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify({ type:'ratings-save', employeeId: employeeData.id, ratings: r }) });

        // local: atualiza travas e checkpoint salvo
        lockedIndex = newLockedIndex;
        lastSavedCheckpoint = checkpointStepIndex();

        const btn=document.getElementById('saveBtn'); const txt=btn.innerHTML;
        btn.innerHTML='<i class="fas fa-check"></i> Salvo!';
        setTimeout(()=>btn.innerHTML=txt,1500);
        showToast('Progresso salvo e sincronizado.');
        applySequentialLocking();
        updateStepStatuses();
      }catch(err){
        console.error(err);
        showToast('Falha ao contatar o Web App.');
      }
    }

    /* ===== TXT inclui AVALIAÇÕES ===== */
    function buildTxtReport(){
      const completed=getCompletedTaskIds();
      const pending=ORDERED_TASK_IDS.filter(id=>!completed.includes(id));
      const all=ORDERED_TASK_IDS.length; const done=completed.length;
      const pct=all?Math.round((done/all)*100):0;
      const today=new Date().toLocaleDateString('pt-BR',{timeZone:'America/Sao_Paulo'});
      const ratings=getRatings();

      const lines=[];
      lines.push('RELATÓRIO DE ONBOARDING','');
      lines.push(`Funcionário: ${employeeData.name}`);
      lines.push(`Cargo: ${employeeData.position}`);
      lines.push(`Data de Início: ${employeeData.startDate}`);
      lines.push(`Gerente: ${employeeData.manager}`);
      lines.push(`Data do Relatório: ${today}`,'');
      lines.push('PROGRESSO GERAL');
      lines.push(`Total de tarefas: ${all}`);
      lines.push(`Tarefas concluídas: ${done}`);
      lines.push(`Percentual: ${pct}%`,'');
      lines.push('TAREFAS CONCLUÍDAS:'); for (const id of completed){ lines.push(`✓ ${getTaskTextById(id)}`); }
      lines.push('', 'TAREFAS PENDENTES:'); for (const id of pending){ lines.push(`○ ${getTaskTextById(id)}`); }
      lines.push('', 'AVALIAÇÕES POR ETAPA (1–5):');
      for (const s of STEPS){ const r = ratings[String(s.id)]; lines.push(`- ${s.title}: ${r ? r + '/5' : 'sem avaliação'}`); }
      return lines.join('\n');
    }

    function generateReportTXT(){
      const content=buildTxtReport();
      const blob=new Blob([content],{type:'text/plain;charset=utf-8'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      const safe=(employeeData.name||'Funcionario').replace(/\s+/g,'_');
      const iso=new Date().toISOString().slice(0,10);
      a.href=url; a.download=`relatorio_onboarding_${safe}_${iso}.txt`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    /* ===== helpers de funcionário/DOM ===== */
    function getSavedEmployeeRecord(){ const employees=JSON.parse(localStorage.getItem('employees')||'[]'); return employees.find(e=>e.id===employeeData.id); }
    function loadCurrentEmployee(){
      const stored=localStorage.getItem('currentEmployee');
      if(stored){
        const emp=JSON.parse(stored);
        employeeData={ id:emp.id, name:emp.name, position:emp.position, startDate:formatDate(emp.startDate), manager:emp.manager };
      }
      renderEmployeeInfo();
    }
    function renderEmployeeInfo(){ document.getElementById('employeeName').textContent=employeeData.name; document.getElementById('employeePosition').textContent=employeeData.position; document.getElementById('startDate').textContent=employeeData.startDate; document.getElementById('managerName').textContent=employeeData.manager; }
    function formatDate(s){ const d=new Date(s); return isNaN(d)? String(s) : d.toLocaleDateString('pt-BR'); }

    function getTaskTextById(id){ const el=document.querySelector(`.checklist-item[data-task-id="${id}"] .item-text`); return el?el.textContent.trim():id; }

    /* ===== CORREÇÃO do checkpoint (libera etapa seguinte após salvar) ===== */
    function checkpointStepIndex(){
      if (lockedIndex < 0) return 0;
      const s = stepIndexOfTask(ORDERED_TASK_IDS[lockedIndex]);

      // calcula o índice absoluto do último item dessa etapa
      let firstIdx = 0;
      for (let i = 0; i < s; i++) firstIdx += STEPS[i].tasks.length;
      const lastIdxInStep = firstIdx + STEPS[s].tasks.length - 1;

      // se salvou estando no fim da etapa s -> checkpoint avança para a próxima
      if (lockedIndex >= lastIdxInStep) {
        return Math.min(s + 1, STEPS.length - 1);
      }
      return s;
    }
  </script>
</body>
</html>
