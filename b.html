<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Feedback da Integração</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;line-height:1.6;color:#eaeaea;background:#1a1a1a;min-height:100vh;padding:20px 0}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}

    .header{background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%);color:#fff;padding:40px 30px;text-align:center;border-radius:15px 15px 0 0;box-shadow:0 4px 20px rgba(0,0,0,.3);position:relative;overflow:hidden}
    .header::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.06) 0%,transparent 70%);animation:rotate 30s linear infinite}
    @keyframes rotate{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    .header-content{position:relative;z-index:1}
    .header-icon{font-size:3em;margin-bottom:16px;color:#4CAF50}
    .header h1{font-size:2.1em;font-weight:800;margin-bottom:6px}
    .header h2{font-size:1.15em;font-weight:500;opacity:.95}

    .main{background:#2a2a2a;border-radius:0 0 15px 15px;box-shadow:0 4px 20px rgba(0,0,0,.3);padding:28px}
    .card{background:#3a3a3a;border-radius:12px;padding:22px;margin-bottom:22px;box-shadow:0 4px 15px rgba(0,0,0,.2)}
    .card h3{display:flex;align-items:center;gap:10px;margin-bottom:12px;color:#fff}
    .badge{padding:4px 10px;border-radius:999px;font-size:.78rem;background:#424242;color:#e0e0e0}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}

    label{display:block;color:#eaeaea;font-weight:700;margin-bottom:6px}
    input[type="text"],input[type="email"],input[type="date"],textarea,select,input[type="number"]{
      width:100%;background:#4a4a4a;border:2px solid #555;border-radius:10px;padding:11px 12px;color:#fff;transition:.2s
    }
    textarea{min-height:90px;resize:vertical}
    input:read-only{opacity:.85}
    input:focus,textarea:focus,select:focus{outline:none;border-color:#4CAF50;box-shadow:0 0 0 3px rgba(76,175,80,.2);background:#565656}
    input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
    input[type="number"]{appearance:textfield}

    .q{background:#444;border:2px solid #555;border-radius:10px;padding:14px}
    .q + .q{margin-top:12px}
    .q p{font-weight:600;color:#a5e8b1;margin-bottom:8px}
    .inline{display:flex;gap:10px;flex-wrap:wrap}
    .opt{background:#4a4a4a;border:2px solid #666;border-radius:10px;padding:8px 12px;display:inline-flex;align-items:center;gap:8px;cursor:pointer}
    .opt input{display:none}
    .dot{width:16px;height:16px;border:2px solid #888;border-radius:50%}
    .opt input:checked + .dot{background:#4CAF50;border-color:#4CAF50}

    .actions{display:flex;gap:14px;justify-content:center;margin-top:18px;padding-top:16px;border-top:2px solid #555;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:12px 20px;border:none;border-radius:10px;font-weight:800;cursor:pointer;text-transform:uppercase}
    .btn-primary{background:linear-gradient(135deg,#4CAF50 0%,#45a049 100%);color:#fff}
    .btn-secondary{background:linear-gradient(135deg,#2196F3 0%,#1976D2 100%);color:#fff}

    .ok{display:none;background:#2e7d32;color:#fff;border-radius:10px;padding:14px;text-align:center;margin-bottom:14px}
    .err{display:none;background:#b71c1c;color:#fff;border-radius:10px;padding:14px;text-align:center;margin-bottom:14px}

    /* Overlay de carregamento (estilo onboarding) */
    .overlay{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.65);backdrop-filter:blur(2px);z-index:9999
    }
    .overlay.show{display:flex}
    .loader{
      display:flex;flex-direction:column;align-items:center;gap:14px;
      background:#262626;border:1px solid #444;border-radius:16px;padding:22px 26px;box-shadow:0 10px 30px rgba(0,0,0,.45)
    }
    .spinner{
      width:52px;height:52px;border-radius:50%;
      border:4px solid #555;border-top-color:#4CAF50;animation:spin 1s linear infinite
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .loader h4{margin:0;color:#fff}
    .loader small{color:#cfcfcf}
    .loader .actions{border:0;margin:0;padding:0}

    /* Esqueleto rápido para os campos read-only enquanto carrega */
    .skeleton{position:relative;overflow:hidden;background:#4a4a4a}
    .skeleton::after{
      content:"";position:absolute;inset:0;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.06), transparent);
      animation:shimmer 1.2s infinite
    }
    @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

    .is-disabled{opacity:.6;pointer-events:none}
    @media(max-width:820px){.col-6{grid-column:span 12}.col-4{grid-column:span 12}}
  </style>
</head>
<body>
  <!-- Overlay -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="loader" role="status" aria-live="polite">
      <div class="spinner" aria-label="Carregando"></div>
      <h4>Carregando dados do colaborador…</h4>
      <small>Buscando informações na planilha. Pode levar alguns segundos.</small>
      <div class="actions">
        <button id="btnRetry" class="btn btn-secondary" type="button">
          <i class="fas fa-rotate-right"></i> Tentar novamente
        </button>
        <button id="btnContinuarSemPrefill" class="btn btn-primary" type="button">
          <i class="fas fa-forward"></i> Continuar sem preencher
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <header class="header">
      <div class="header-content">
        <i class="fas fa-comments header-icon"></i>
        <h1>FEEDBACK DA INTEGRAÇÃO</h1>
        <h2>Conte pra gente como foi sua experiência na loja</h2>
      </div>
    </header>

    <main class="main">
      <div id="ok" class="ok"><i class="fas fa-check-circle"></i> Feedback enviado. Obrigado!</div>
      <div id="err" class="err"><i class="fas fa-triangle-exclamation"></i> Não foi possível enviar. Tente novamente.</div>

      <!-- Dados do colaborador -->
      <section class="card" id="secDados">
        <h3><i class="fas fa-id-badge"></i> Seus dados <span class="badge">preenchidos automaticamente</span></h3>
        <div class="grid">
          <div class="col-6">
            <label>Nome</label>
            <input id="employeeName" type="text" readonly class="skeleton">
          </div>
          <div class="col-6">
            <label>E-mail</label>
            <input id="email" type="email" readonly class="skeleton">
          </div>
          <div class="col-4">
            <label>Cargo</label>
            <input id="position" type="text" readonly class="skeleton">
          </div>
          <div class="col-4">
            <label>Data de Início</label>
            <input id="startDate" type="text" readonly class="skeleton">
          </div>
          <div class="col-4">
            <label>Gerente</label>
            <input id="manager" type="text" readonly class="skeleton">
          </div>
          <input id="employeeId" type="hidden">
        </div>
      </section>

      <!-- Perguntas -->
      <section class="card" id="secForm">
        <h3><i class="fas fa-list-check"></i> Questionário</h3>

        <form id="fbForm" class="is-disabled" aria-disabled="true">
          <div class="q">
            <p>1) Ficou claro quais serão suas tarefas?</p>
            <div class="inline">
              <label class="opt"><input type="radio" name="q1" value="Sim"><span class="dot"></span>Sim</label>
              <label class="opt"><input type="radio" name="q1" value="Parcialmente"><span class="dot"></span>Parcialmente</label>
              <label class="opt"><input type="radio" name="q1" value="Não"><span class="dot"></span>Não</label>
            </div>
          </div>

          <div class="q">
            <p>2) Quem mais te ajudou no processo?</p>
            <select name="q2" required>
              <option value="" disabled selected>Selecione</option>
              <option value="vendedora">Vendedora</option>
              <option value="estoquista">Estoquista</option>
              <option value="caixa">Caixa</option>
              <option value="gerente">Gerente</option>
            </select>
          </div>

          <div class="q"><p>3) Quanto você se sente seguro(a) para atuar na área solicitada? (0 a 10)</p><input type="number" name="q3" min="0" max="10" step="1" inputmode="numeric"></div>
          <div class="q"><p>4) O que você achou mais difícil e mais fácil?</p><textarea name="q4"></textarea></div>

          <div class="q">
            <p>5) O direcionamento da gerência acontece com que frequência na sua percepção?</p>
            <div class="inline">
              <label class="opt"><input type="radio" name="q5" value="Sempre"><span class="dot"></span>Sempre</label>
              <label class="opt"><input type="radio" name="q5" value="Às vezes"><span class="dot"></span>Às vezes</label>
              <label class="opt"><input type="radio" name="q5" value="Nunca"><span class="dot"></span>Nunca</label>
            </div>
          </div>

          <div class="q">
            <p>6) Você se sente parte da equipe após a integração?</p>
            <div class="inline">
              <label class="opt"><input type="radio" name="q6" value="Sim"><span class="dot"></span>Sim</label>
              <label class="opt"><input type="radio" name="q6" value="Não"><span class="dot"></span>Não</label>
            </div>
            <textarea name="q6_just" placeholder="Se marcou 'Não', explique..." style="display:none"></textarea>
          </div>

          <div class="q"><p>7) Foi lhe apresentado todas as ferramentas e sistemas da empresa? Se sim, qual te chamou mais atenção?</p><textarea name="q7"></textarea></div>

          <div class="q">
            <p>8) Foi lhe apresentado o estoque?</p>
            <div class="inline">
              <label class="opt"><input type="radio" name="q8" value="Sim"><span class="dot"></span>Sim</label>
              <label class="opt"><input type="radio" name="q8" value="Não"><span class="dot"></span>Não</label>
            </div>
          </div>

          <div class="q">
            <p>9) Foi lhe apresentada a área de vendas? (dobras, divisões de setores etc.)</p>
            <div class="inline">
              <label class="opt"><input type="radio" name="q9" value="Sim"><span class="dot"></span>Sim</label>
              <label class="opt"><input type="radio" name="q9" value="Não"><span class="dot"></span>Não</label>
            </div>
          </div>

          <div class="q"><p>10) Como foi seu primeiro dia de vendas?</p><textarea name="q10"></textarea></div>

          <div class="q">
            <p>11) Você acha que teve um bom acompanhamento e auxílio durante seus atendimentos?</p>
            <div class="inline">
              <label class="opt"><input type="radio" name="q11" value="Sim"><span class="dot"></span>Sim</label>
              <label class="opt"><input type="radio" name="q11" value="Não"><span class="dot"></span>Não</label>
            </div>
            <textarea name="q11_obs" placeholder="Se marcou 'Não', descreva..." style="display:none"></textarea>
          </div>

          <div class="q"><p>12) Dê uma sugestão para melhorarmos a integração.</p><textarea name="q12"></textarea></div>

          <div class="actions">
            <button class="btn btn-primary" type="submit"><i class="fas fa-paper-plane"></i> Enviar feedback</button>
            <!-- Botão Home removido -->
          </div>
        </form>
      </section>
    </main>
  </div>

  <script>
    const GAS = 'https://script.google.com/macros/s/AKfycbzx7fZB5WPpdAI7nUADWhzWZF83CyTKIl50jkOeJanoPao9t1eecOQ5CrshZksO5A5e/exec';

    const $ = (s,all=false)=> all?document.querySelectorAll(s):document.querySelector(s);
    function qs(k){ return new URLSearchParams(location.search).get(k) || ''; }
    function setVal(id,v){ const el=document.getElementById(id); if(el){ el.value=v||''; el.classList.remove('skeleton'); } }

    const overlay = document.getElementById('overlay');
    const btnRetry = document.getElementById('btnRetry');
    const btnSkip  = document.getElementById('btnContinuarSemPrefill');
    const form = document.getElementById('fbForm');

    function setLoadingUI(loading){
      overlay.classList.toggle('show', loading);
      overlay.setAttribute('aria-hidden', loading ? 'false' : 'true');
      form.classList.toggle('is-disabled', loading);
      form.setAttribute('aria-disabled', loading ? 'true' : 'false');
    }

    function toggleConditional(groupName, textareaName) {
      const radios = document.querySelectorAll(`input[name="${groupName}"]`);
      const ta = document.querySelector(`textarea[name="${textareaName}"]`);
      if (!radios.length || !ta) return;
      const update = () => {
        const val = Array.from(radios).find(r => r.checked)?.value;
        ta.style.display = (val === 'Não') ? 'block' : 'none';
        if (val !== 'Não') ta.value = '';
      };
      radios.forEach(r => r.addEventListener('change', update));
      update();
    }

    // fetch com timeout
    async function fetchWithTimeout(url, ms=12000){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), ms);
      try{ return await fetch(url, { signal: ctrl.signal, cache:'no-store' }); }
      finally{ clearTimeout(t); }
    }

    // PREFILL correto (passa q exatamente como veio no link do e-mail)
    async function prefill(attempt=1){
      const q=qs('q'), token=qs('token'); // token é ignorado pelo backend, mantido por compat
      if(!q || !token){
        // sem parâmetros → libera o formulário sem prefill
        setLoadingUI(false);
        ['employeeName','email','position','startDate','manager'].forEach(id=>{
          const el=document.getElementById(id); if(el) el.classList.remove('skeleton');
        });
        return;
      }
      setLoadingUI(true);
      try{
        // q já é JSON stringificado vindo no link do e-mail
        const url = `${GAS}?view=feedback&q=${encodeURIComponent(q)}&token=${encodeURIComponent(token)}`;
        const r = await fetchWithTimeout(url, 12000);
        if(!r.ok) throw new Error('HTTP '+r.status);
        const out = await r.json();

        if(out?.ok && out.record){
          const d = out.record;
          setVal('employeeId', d.employeeId);
          setVal('employeeName', d.name);
          setVal('email', d.email);
          setVal('position', d.position);
          setVal('startDate', d.startDate);
          setVal('manager', d.manager);
          setLoadingUI(false);
          return;
        }

        // ok=false ou record=null → libera uso sem prefill, mas mostra alerta
        document.getElementById('err').style.display='block';
        setLoadingUI(false);
      }catch(e){
        // erro/timeout → se 1ª ou 2ª tentativa, deixa overlay com botão "Tentar novamente"
        if(attempt < 2){
          overlay.classList.add('show');
          btnRetry.onclick = () => prefill(attempt+1);
          btnSkip.onclick  = () => { setLoadingUI(false); };
        }else{
          document.getElementById('err').style.display='block';
          setLoadingUI(false);
        }
      }finally{
        // remove skeletons visuais, mesmo se falhar
        ['employeeName','email','position','startDate','manager'].forEach(id=>{
          const el=document.getElementById(id); if(el) el.classList.remove('skeleton');
        });
      }
    }

    // Envio do formulário
    document.getElementById('fbForm').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      // overlay rápido durante o envio
      overlay.querySelector('h4').textContent = 'Enviando seu feedback…';
      overlay.querySelector('small').textContent = 'Aguarde a confirmação.';
      setLoadingUI(true);

      const fd = new FormData(ev.target);
      const payload = {
        type:'feedback-submit',
        employeeId: document.getElementById('employeeId').value,
        name:       document.getElementById('employeeName').value,
        email:      document.getElementById('email').value,
        position:   document.getElementById('position').value,
        startDate:  document.getElementById('startDate').value,
        manager:    document.getElementById('manager').value,
        answers: Object.fromEntries(fd.entries())
      };
      try{
        const res = await fetch(GAS, { method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify(payload) });
        const out = await res.json();
        if(out.ok){
          document.getElementById('ok').style.display='block';
          document.getElementById('err').style.display='none';
          window.scrollTo({top:0,behavior:'smooth'});
          ev.target.reset();
        }else{
          document.getElementById('err').style.display='block';
        }
      }catch(_){
        document.getElementById('err').style.display='block';
      }finally{
        // volta o overlay para o texto padrão e esconde
        overlay.querySelector('h4').textContent = 'Carregando dados do colaborador…';
        overlay.querySelector('small').textContent = 'Buscando informações na planilha. Pode levar alguns segundos.';
        setLoadingUI(false);
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      // Inicial
      setLoadingUI(true);
      // Campos condicionais
      toggleConditional('q6', 'q6_just');
      toggleConditional('q11', 'q11_obs');
      // Prefill
      prefill();
    });
  </script>
</body>
</html>
